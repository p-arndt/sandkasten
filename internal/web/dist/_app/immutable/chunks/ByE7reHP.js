import{w as ut,q as dt,p as ue,a as de,c as se,g as oe,I as ve,s as $e,T as ct,t as Xe,u as mt,v as xe,x as Ye,y as ht,d as ce,e as _t,l as ft,f as _e,k as Ie,m as fe,U as pe,B as yt,C as gt,D as vt,E as bt,n as j,o as wt,F as ne,G as xt,z as D}from"./p6dsmFtl.js";import{d as It,Z as kt,o,s as e,a as v,e as Z,l,n as s,_ as H,r as ee,u as F,b as Q,f as Qe,g as ye,h as Ct,c as ke}from"./pRZOK57-.js";function Tt(t){return It(kt,t)}var Ce=o({error:o({message:e(),type:e().nullish(),param:ye().nullish(),code:F([e(),s()]).nullish()})}),le=wt({errorSchema:Ce,errorToMessage:t=>t.error.message});function et(t){const r=t.startsWith("o3")||t.startsWith("o4-mini")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-chat"),m=t.startsWith("gpt-4")||t.startsWith("gpt-5-mini")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-nano")&&!t.startsWith("gpt-5-chat")||t.startsWith("o3")||t.startsWith("o4-mini"),p=t.startsWith("o1")||t.startsWith("o3")||t.startsWith("o4-mini")||t.startsWith("codex-mini")||t.startsWith("computer-use-preview")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-chat"),d=t.startsWith("gpt-5.1")||t.startsWith("gpt-5.2");return{supportsFlexProcessing:r,supportsPriorityProcessing:m,isReasoningModel:p,systemMessageMode:p?"developer":"system",supportsNonReasoningParameters:d}}function Ee(t){var r,m,p,d,u,i;if(t==null)return{inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0},raw:void 0};const c=(r=t.prompt_tokens)!=null?r:0,f=(m=t.completion_tokens)!=null?m:0,y=(d=(p=t.prompt_tokens_details)==null?void 0:p.cached_tokens)!=null?d:0,q=(i=(u=t.completion_tokens_details)==null?void 0:u.reasoning_tokens)!=null?i:0;return{inputTokens:{total:c,noCache:c-y,cacheRead:y,cacheWrite:void 0},outputTokens:{total:f,text:f-q,reasoning:q},raw:t}}function qt({prompt:t,systemMessageMode:r="system"}){var m;const p=[],d=[];for(const{role:u,content:i}of t)switch(u){case"system":{switch(r){case"system":{p.push({role:"system",content:i});break}case"developer":{p.push({role:"developer",content:i});break}case"remove":{d.push({type:"other",message:"system messages are removed for this model"});break}default:{const c=r;throw new Error(`Unsupported system message mode: ${c}`)}}break}case"user":{if(i.length===1&&i[0].type==="text"){p.push({role:"user",content:i[0].text});break}p.push({role:"user",content:i.map((c,f)=>{var y,q,R;switch(c.type){case"text":return{type:"text",text:c.text};case"file":if(c.mediaType.startsWith("image/")){const I=c.mediaType==="image/*"?"image/jpeg":c.mediaType;return{type:"image_url",image_url:{url:c.data instanceof URL?c.data.toString():`data:${I};base64,${fe(c.data)}`,detail:(q=(y=c.providerOptions)==null?void 0:y.openai)==null?void 0:q.imageDetail}}}else if(c.mediaType.startsWith("audio/")){if(c.data instanceof URL)throw new pe({functionality:"audio file parts with URLs"});switch(c.mediaType){case"audio/wav":return{type:"input_audio",input_audio:{data:fe(c.data),format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:fe(c.data),format:"mp3"}};default:throw new pe({functionality:`audio content parts with media type ${c.mediaType}`})}}else if(c.mediaType==="application/pdf"){if(c.data instanceof URL)throw new pe({functionality:"PDF file parts with URLs"});return{type:"file",file:typeof c.data=="string"&&c.data.startsWith("file-")?{file_id:c.data}:{filename:(R=c.filename)!=null?R:`part-${f}.pdf`,file_data:`data:application/pdf;base64,${fe(c.data)}`}}}else throw new pe({functionality:`file part media type ${c.mediaType}`})}})});break}case"assistant":{let c="";const f=[];for(const y of i)switch(y.type){case"text":{c+=y.text;break}case"tool-call":{f.push({id:y.toolCallId,type:"function",function:{name:y.toolName,arguments:JSON.stringify(y.input)}});break}}p.push({role:"assistant",content:c,tool_calls:f.length>0?f:void 0});break}case"tool":{for(const c of i){if(c.type==="tool-approval-response")continue;const f=c.output;let y;switch(f.type){case"text":case"error-text":y=f.value;break;case"execution-denied":y=(m=f.reason)!=null?m:"Tool execution denied.";break;case"content":case"json":case"error-json":y=JSON.stringify(f.value);break}p.push({role:"tool",tool_call_id:c.toolCallId,content:y})}break}default:{const c=u;throw new Error(`Unsupported role: ${c}`)}}return{messages:p,warnings:d}}function be({id:t,model:r,created:m}){return{id:t??void 0,modelId:r??void 0,timestamp:m?new Date(m*1e3):void 0}}function je(t){switch(t){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"other"}}var St=j(()=>D(o({id:e().nullish(),created:s().nullish(),model:e().nullish(),choices:v(o({message:o({role:l("assistant").nullish(),content:e().nullish(),tool_calls:v(o({id:e().nullish(),type:l("function"),function:o({name:e(),arguments:e()})})).nullish(),annotations:v(o({type:l("url_citation"),url_citation:o({start_index:s(),end_index:s(),url:e(),title:e()})})).nullish()}),index:s(),logprobs:o({content:v(o({token:e(),logprob:s(),top_logprobs:v(o({token:e(),logprob:s()}))})).nullish()}).nullish(),finish_reason:e().nullish()})),usage:o({prompt_tokens:s().nullish(),completion_tokens:s().nullish(),total_tokens:s().nullish(),prompt_tokens_details:o({cached_tokens:s().nullish()}).nullish(),completion_tokens_details:o({reasoning_tokens:s().nullish(),accepted_prediction_tokens:s().nullish(),rejected_prediction_tokens:s().nullish()}).nullish()}).nullish()}))),Nt=j(()=>D(F([o({id:e().nullish(),created:s().nullish(),model:e().nullish(),choices:v(o({delta:o({role:H(["assistant"]).nullish(),content:e().nullish(),tool_calls:v(o({index:s(),id:e().nullish(),type:l("function").nullish(),function:o({name:e().nullish(),arguments:e().nullish()})})).nullish(),annotations:v(o({type:l("url_citation"),url_citation:o({start_index:s(),end_index:s(),url:e(),title:e()})})).nullish()}).nullish(),logprobs:o({content:v(o({token:e(),logprob:s(),top_logprobs:v(o({token:e(),logprob:s()}))})).nullish()}).nullish(),finish_reason:e().nullish(),index:s()})),usage:o({prompt_tokens:s().nullish(),completion_tokens:s().nullish(),total_tokens:s().nullish(),prompt_tokens_details:o({cached_tokens:s().nullish()}).nullish(),completion_tokens_details:o({reasoning_tokens:s().nullish(),accepted_prediction_tokens:s().nullish(),rejected_prediction_tokens:s().nullish()}).nullish()}).nullish()}),Ce]))),Rt=j(()=>D(o({logitBias:ee(Tt(),s()).optional(),logprobs:F([Q(),s()]).optional(),parallelToolCalls:Q().optional(),user:e().optional(),reasoningEffort:H(["none","minimal","low","medium","high","xhigh"]).optional(),maxCompletionTokens:s().optional(),store:Q().optional(),metadata:ee(e().max(64),e().max(512)).optional(),prediction:ee(e(),ye()).optional(),serviceTier:H(["auto","flex","priority","default"]).optional(),strictJsonSchema:Q().optional(),textVerbosity:H(["low","medium","high"]).optional(),promptCacheKey:e().optional(),promptCacheRetention:H(["in_memory","24h"]).optional(),safetyIdentifier:e().optional(),systemMessageMode:H(["system","developer","remove"]).optional(),forceReasoning:Q().optional()})));function Mt({tools:t,toolChoice:r}){t=t?.length?t:void 0;const m=[];if(t==null)return{tools:void 0,toolChoice:void 0,toolWarnings:m};const p=[];for(const u of t)u.type==="function"?p.push({type:"function",function:{name:u.name,description:u.description,parameters:u.inputSchema,...u.strict!=null?{strict:u.strict}:{}}}):m.push({type:"unsupported",feature:`tool type: ${u.type}`});if(r==null)return{tools:p,toolChoice:void 0,toolWarnings:m};const d=r.type;switch(d){case"auto":case"none":case"required":return{tools:p,toolChoice:d,toolWarnings:m};case"tool":return{tools:p,toolChoice:{type:"function",function:{name:r.toolName}},toolWarnings:m};default:{const u=d;throw new pe({functionality:`tool choice type: ${u}`})}}}var Pt=class{constructor(t,r){this.specificationVersion="v3",this.supportedUrls={"image/*":[/^https?:\/\/.*$/]},this.modelId=t,this.config=r}get provider(){return this.config.provider}async getArgs({prompt:t,maxOutputTokens:r,temperature:m,topP:p,topK:d,frequencyPenalty:u,presencePenalty:i,stopSequences:c,responseFormat:f,seed:y,tools:q,toolChoice:R,providerOptions:I}){var x,S,O,h,U;const E=[],C=(x=await ue({provider:"openai",providerOptions:I,schema:Rt}))!=null?x:{},J=et(this.modelId),V=(S=C.forceReasoning)!=null?S:J.isReasoningModel;d!=null&&E.push({type:"unsupported",feature:"topK"});const{messages:n,warnings:M}=qt({prompt:t,systemMessageMode:(O=C.systemMessageMode)!=null?O:V?"developer":J.systemMessageMode});E.push(...M);const B=(h=C.strictJsonSchema)!=null?h:!0,N={model:this.modelId,logit_bias:C.logitBias,logprobs:C.logprobs===!0||typeof C.logprobs=="number"?!0:void 0,top_logprobs:typeof C.logprobs=="number"?C.logprobs:typeof C.logprobs=="boolean"&&C.logprobs?0:void 0,user:C.user,parallel_tool_calls:C.parallelToolCalls,max_tokens:r,temperature:m,top_p:p,frequency_penalty:u,presence_penalty:i,response_format:f?.type==="json"?f.schema!=null?{type:"json_schema",json_schema:{schema:f.schema,strict:B,name:(U=f.name)!=null?U:"response",description:f.description}}:{type:"json_object"}:void 0,stop:c,seed:y,verbosity:C.textVerbosity,max_completion_tokens:C.maxCompletionTokens,store:C.store,metadata:C.metadata,prediction:C.prediction,reasoning_effort:C.reasoningEffort,service_tier:C.serviceTier,prompt_cache_key:C.promptCacheKey,prompt_cache_retention:C.promptCacheRetention,safety_identifier:C.safetyIdentifier,messages:n};V?((C.reasoningEffort!=="none"||!J.supportsNonReasoningParameters)&&(N.temperature!=null&&(N.temperature=void 0,E.push({type:"unsupported",feature:"temperature",details:"temperature is not supported for reasoning models"})),N.top_p!=null&&(N.top_p=void 0,E.push({type:"unsupported",feature:"topP",details:"topP is not supported for reasoning models"})),N.logprobs!=null&&(N.logprobs=void 0,E.push({type:"other",message:"logprobs is not supported for reasoning models"}))),N.frequency_penalty!=null&&(N.frequency_penalty=void 0,E.push({type:"unsupported",feature:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),N.presence_penalty!=null&&(N.presence_penalty=void 0,E.push({type:"unsupported",feature:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),N.logit_bias!=null&&(N.logit_bias=void 0,E.push({type:"other",message:"logitBias is not supported for reasoning models"})),N.top_logprobs!=null&&(N.top_logprobs=void 0,E.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),N.max_tokens!=null&&(N.max_completion_tokens==null&&(N.max_completion_tokens=N.max_tokens),N.max_tokens=void 0)):(this.modelId.startsWith("gpt-4o-search-preview")||this.modelId.startsWith("gpt-4o-mini-search-preview"))&&N.temperature!=null&&(N.temperature=void 0,E.push({type:"unsupported",feature:"temperature",details:"temperature is not supported for the search preview models and has been removed."})),C.serviceTier==="flex"&&!J.supportsFlexProcessing&&(E.push({type:"unsupported",feature:"serviceTier",details:"flex processing is only available for o3, o4-mini, and gpt-5 models"}),N.service_tier=void 0),C.serviceTier==="priority"&&!J.supportsPriorityProcessing&&(E.push({type:"unsupported",feature:"serviceTier",details:"priority processing is only available for supported models (gpt-4, gpt-5, gpt-5-mini, o3, o4-mini) and requires Enterprise access. gpt-5-nano is not supported"}),N.service_tier=void 0);const{tools:K,toolChoice:W,toolWarnings:b}=Mt({tools:q,toolChoice:R});return{args:{...N,tools:K,tool_choice:W},warnings:[...E,...b]}}async doGenerate(t){var r,m,p,d,u,i,c;const{args:f,warnings:y}=await this.getArgs(t),{responseHeaders:q,value:R,rawValue:I}=await de({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),body:f,failedResponseHandler:le,successfulResponseHandler:_e(St),abortSignal:t.abortSignal,fetch:this.config.fetch}),x=R.choices[0],S=[],O=x.message.content;O!=null&&O.length>0&&S.push({type:"text",text:O});for(const E of(r=x.message.tool_calls)!=null?r:[])S.push({type:"tool-call",toolCallId:(m=E.id)!=null?m:oe(),toolName:E.function.name,input:E.function.arguments});for(const E of(p=x.message.annotations)!=null?p:[])S.push({type:"source",sourceType:"url",id:oe(),url:E.url_citation.url,title:E.url_citation.title});const h=(d=R.usage)==null?void 0:d.completion_tokens_details;(u=R.usage)==null||u.prompt_tokens_details;const U={openai:{}};return h?.accepted_prediction_tokens!=null&&(U.openai.acceptedPredictionTokens=h?.accepted_prediction_tokens),h?.rejected_prediction_tokens!=null&&(U.openai.rejectedPredictionTokens=h?.rejected_prediction_tokens),((i=x.logprobs)==null?void 0:i.content)!=null&&(U.openai.logprobs=x.logprobs.content),{content:S,finishReason:{unified:je(x.finish_reason),raw:(c=x.finish_reason)!=null?c:void 0},usage:Ee(R.usage),request:{body:f},response:{...be(R),headers:q,body:I},warnings:y,providerMetadata:U}}async doStream(t){const{args:r,warnings:m}=await this.getArgs(t),p={...r,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:d,value:u}=await de({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),body:p,failedResponseHandler:le,successfulResponseHandler:Ie(Nt),abortSignal:t.abortSignal,fetch:this.config.fetch}),i=[];let c={unified:"other",raw:void 0},f,y=!1,q=!1;const R={openai:{}};return{stream:u.pipeThrough(new TransformStream({start(I){I.enqueue({type:"stream-start",warnings:m})},transform(I,x){var S,O,h,U,E,C,J,V,n,M,B,N,K,W,b,_,T;if(t.includeRawChunks&&x.enqueue({type:"raw",rawValue:I.rawValue}),!I.success){c={unified:"error",raw:void 0},x.enqueue({type:"error",error:I.error});return}const P=I.value;if("error"in P){c={unified:"error",raw:void 0},x.enqueue({type:"error",error:P.error});return}if(!y){const A=be(P);Object.values(A).some(Boolean)&&(y=!0,x.enqueue({type:"response-metadata",...be(P)}))}P.usage!=null&&(f=P.usage,((S=P.usage.completion_tokens_details)==null?void 0:S.accepted_prediction_tokens)!=null&&(R.openai.acceptedPredictionTokens=(O=P.usage.completion_tokens_details)==null?void 0:O.accepted_prediction_tokens),((h=P.usage.completion_tokens_details)==null?void 0:h.rejected_prediction_tokens)!=null&&(R.openai.rejectedPredictionTokens=(U=P.usage.completion_tokens_details)==null?void 0:U.rejected_prediction_tokens));const g=P.choices[0];if(g?.finish_reason!=null&&(c={unified:je(g.finish_reason),raw:g.finish_reason}),((E=g?.logprobs)==null?void 0:E.content)!=null&&(R.openai.logprobs=g.logprobs.content),g?.delta==null)return;const z=g.delta;if(z.content!=null&&(q||(x.enqueue({type:"text-start",id:"0"}),q=!0),x.enqueue({type:"text-delta",id:"0",delta:z.content})),z.tool_calls!=null)for(const A of z.tool_calls){const ae=A.index;if(i[ae]==null){if(A.type!=="function")throw new ve({data:A,message:"Expected 'function' type."});if(A.id==null)throw new ve({data:A,message:"Expected 'id' to be a string."});if(((C=A.function)==null?void 0:C.name)==null)throw new ve({data:A,message:"Expected 'function.name' to be a string."});x.enqueue({type:"tool-input-start",id:A.id,toolName:A.function.name}),i[ae]={id:A.id,type:"function",function:{name:A.function.name,arguments:(J=A.function.arguments)!=null?J:""},hasFinished:!1};const X=i[ae];((V=X.function)==null?void 0:V.name)!=null&&((n=X.function)==null?void 0:n.arguments)!=null&&(X.function.arguments.length>0&&x.enqueue({type:"tool-input-delta",id:X.id,delta:X.function.arguments}),$e(X.function.arguments)&&(x.enqueue({type:"tool-input-end",id:X.id}),x.enqueue({type:"tool-call",toolCallId:(M=X.id)!=null?M:oe(),toolName:X.function.name,input:X.function.arguments}),X.hasFinished=!0));continue}const $=i[ae];$.hasFinished||(((B=A.function)==null?void 0:B.arguments)!=null&&($.function.arguments+=(K=(N=A.function)==null?void 0:N.arguments)!=null?K:""),x.enqueue({type:"tool-input-delta",id:$.id,delta:(W=A.function.arguments)!=null?W:""}),((b=$.function)==null?void 0:b.name)!=null&&((_=$.function)==null?void 0:_.arguments)!=null&&$e($.function.arguments)&&(x.enqueue({type:"tool-input-end",id:$.id}),x.enqueue({type:"tool-call",toolCallId:(T=$.id)!=null?T:oe(),toolName:$.function.name,input:$.function.arguments}),$.hasFinished=!0))}if(z.annotations!=null)for(const A of z.annotations)x.enqueue({type:"source",sourceType:"url",id:oe(),url:A.url_citation.url,title:A.url_citation.title})},flush(I){q&&I.enqueue({type:"text-end",id:"0"}),I.enqueue({type:"finish",finishReason:c,usage:Ee(f),...R!=null?{providerMetadata:R}:{}})}})),request:{body:p},response:{headers:d}}}};function De(t){var r,m,p,d;if(t==null)return{inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0},raw:void 0};const u=(r=t.prompt_tokens)!=null?r:0,i=(m=t.completion_tokens)!=null?m:0;return{inputTokens:{total:(p=t.prompt_tokens)!=null?p:void 0,noCache:u,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:(d=t.completion_tokens)!=null?d:void 0,text:i,reasoning:void 0},raw:t}}function Ot({prompt:t,user:r="user",assistant:m="assistant"}){let p="";t[0].role==="system"&&(p+=`${t[0].content}

`,t=t.slice(1));for(const{role:d,content:u}of t)switch(d){case"system":throw new yt({message:"Unexpected system message in prompt: ${content}",prompt:t});case"user":{const i=u.map(c=>{if(c.type==="text")return c.text}).filter(Boolean).join("");p+=`${r}:
${i}

`;break}case"assistant":{const i=u.map(c=>{switch(c.type){case"text":return c.text;case"tool-call":throw new pe({functionality:"tool-call messages"})}}).join("");p+=`${m}:
${i}

`;break}case"tool":throw new pe({functionality:"tool messages"});default:{const i=d;throw new Error(`Unsupported role: ${i}`)}}return p+=`${m}:
`,{prompt:p,stopSequences:[`
${r}:`]}}function We({id:t,model:r,created:m}){return{id:t??void 0,modelId:r??void 0,timestamp:m!=null?new Date(m*1e3):void 0}}function He(t){switch(t){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"other"}}var At=j(()=>D(o({id:e().nullish(),created:s().nullish(),model:e().nullish(),choices:v(o({text:e(),finish_reason:e(),logprobs:o({tokens:v(e()),token_logprobs:v(s()),top_logprobs:v(ee(e(),s())).nullish()}).nullish()})),usage:o({prompt_tokens:s(),completion_tokens:s(),total_tokens:s()}).nullish()}))),$t=j(()=>D(F([o({id:e().nullish(),created:s().nullish(),model:e().nullish(),choices:v(o({text:e(),finish_reason:e().nullish(),index:s(),logprobs:o({tokens:v(e()),token_logprobs:v(s()),top_logprobs:v(ee(e(),s())).nullish()}).nullish()})),usage:o({prompt_tokens:s(),completion_tokens:s(),total_tokens:s()}).nullish()}),Ce]))),Ue=j(()=>D(o({echo:Q().optional(),logitBias:ee(e(),s()).optional(),suffix:e().optional(),user:e().optional(),logprobs:F([Q(),s()]).optional()}))),Et=class{constructor(t,r){this.specificationVersion="v3",this.supportedUrls={},this.modelId=t,this.config=r}get providerOptionsName(){return this.config.provider.split(".")[0].trim()}get provider(){return this.config.provider}async getArgs({prompt:t,maxOutputTokens:r,temperature:m,topP:p,topK:d,frequencyPenalty:u,presencePenalty:i,stopSequences:c,responseFormat:f,tools:y,toolChoice:q,seed:R,providerOptions:I}){const x=[],S={...await ue({provider:"openai",providerOptions:I,schema:Ue}),...await ue({provider:this.providerOptionsName,providerOptions:I,schema:Ue})};d!=null&&x.push({type:"unsupported",feature:"topK"}),y?.length&&x.push({type:"unsupported",feature:"tools"}),q!=null&&x.push({type:"unsupported",feature:"toolChoice"}),f!=null&&f.type!=="text"&&x.push({type:"unsupported",feature:"responseFormat",details:"JSON response format is not supported."});const{prompt:O,stopSequences:h}=Ot({prompt:t}),U=[...h??[],...c??[]];return{args:{model:this.modelId,echo:S.echo,logit_bias:S.logitBias,logprobs:S?.logprobs===!0?0:S?.logprobs===!1?void 0:S?.logprobs,suffix:S.suffix,user:S.user,max_tokens:r,temperature:m,top_p:p,frequency_penalty:u,presence_penalty:i,seed:R,prompt:O,stop:U.length>0?U:void 0},warnings:x}}async doGenerate(t){var r;const{args:m,warnings:p}=await this.getArgs(t),{responseHeaders:d,value:u,rawValue:i}=await de({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),body:m,failedResponseHandler:le,successfulResponseHandler:_e(At),abortSignal:t.abortSignal,fetch:this.config.fetch}),c=u.choices[0],f={openai:{}};return c.logprobs!=null&&(f.openai.logprobs=c.logprobs),{content:[{type:"text",text:c.text}],usage:De(u.usage),finishReason:{unified:He(c.finish_reason),raw:(r=c.finish_reason)!=null?r:void 0},request:{body:m},response:{...We(u),headers:d,body:i},providerMetadata:f,warnings:p}}async doStream(t){const{args:r,warnings:m}=await this.getArgs(t),p={...r,stream:!0,stream_options:{include_usage:!0}},{responseHeaders:d,value:u}=await de({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),body:p,failedResponseHandler:le,successfulResponseHandler:Ie($t),abortSignal:t.abortSignal,fetch:this.config.fetch});let i={unified:"other",raw:void 0};const c={openai:{}};let f,y=!0;return{stream:u.pipeThrough(new TransformStream({start(q){q.enqueue({type:"stream-start",warnings:m})},transform(q,R){if(t.includeRawChunks&&R.enqueue({type:"raw",rawValue:q.rawValue}),!q.success){i={unified:"error",raw:void 0},R.enqueue({type:"error",error:q.error});return}const I=q.value;if("error"in I){i={unified:"error",raw:void 0},R.enqueue({type:"error",error:I.error});return}y&&(y=!1,R.enqueue({type:"response-metadata",...We(I)}),R.enqueue({type:"text-start",id:"0"})),I.usage!=null&&(f=I.usage);const x=I.choices[0];x?.finish_reason!=null&&(i={unified:He(x.finish_reason),raw:x.finish_reason}),x?.logprobs!=null&&(c.openai.logprobs=x.logprobs),x?.text!=null&&x.text.length>0&&R.enqueue({type:"text-delta",id:"0",delta:x.text})},flush(q){y||q.enqueue({type:"text-end",id:"0"}),q.enqueue({type:"finish",finishReason:i,providerMetadata:c,usage:De(f)})}})),request:{body:p},response:{headers:d}}}},jt=j(()=>D(o({dimensions:s().optional(),user:e().optional()}))),Dt=j(()=>D(o({data:v(o({embedding:v(s())})),usage:o({prompt_tokens:s()}).nullish()}))),Wt=class{constructor(t,r){this.specificationVersion="v3",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0,this.modelId=t,this.config=r}get provider(){return this.config.provider}async doEmbed({values:t,headers:r,abortSignal:m,providerOptions:p}){var d;if(t.length>this.maxEmbeddingsPerCall)throw new ct({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:t});const u=(d=await ue({provider:"openai",providerOptions:p,schema:jt}))!=null?d:{},{responseHeaders:i,value:c,rawValue:f}=await de({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:se(this.config.headers(),r),body:{model:this.modelId,input:t,encoding_format:"float",dimensions:u.dimensions,user:u.user},failedResponseHandler:le,successfulResponseHandler:_e(Dt),abortSignal:m,fetch:this.config.fetch});return{warnings:[],embeddings:c.data.map(y=>y.embedding),usage:c.usage?{tokens:c.usage.prompt_tokens}:void 0,response:{headers:i,body:f}}}},Ve=j(()=>D(o({created:s().nullish(),data:v(o({b64_json:e(),revised_prompt:e().nullish()})),background:e().nullish(),output_format:e().nullish(),size:e().nullish(),quality:e().nullish(),usage:o({input_tokens:s().nullish(),output_tokens:s().nullish(),total_tokens:s().nullish(),input_tokens_details:o({image_tokens:s().nullish(),text_tokens:s().nullish()}).nullish()}).nullish()}))),Ht={"dall-e-3":1,"dall-e-2":10,"gpt-image-1":10,"gpt-image-1-mini":10,"gpt-image-1.5":10},Ut=["gpt-image-1-mini","gpt-image-1.5","gpt-image-1"];function Vt(t){return Ut.some(r=>t.startsWith(r))}var zt=class{constructor(t,r){this.modelId=t,this.config=r,this.specificationVersion="v3"}get maxImagesPerCall(){var t;return(t=Ht[this.modelId])!=null?t:1}get provider(){return this.config.provider}async doGenerate({prompt:t,files:r,mask:m,n:p,size:d,aspectRatio:u,seed:i,providerOptions:c,headers:f,abortSignal:y}){var q,R,I,x,S,O,h,U,E,C,J;const V=[];u!=null&&V.push({type:"unsupported",feature:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),i!=null&&V.push({type:"unsupported",feature:"seed"});const n=(I=(R=(q=this.config._internal)==null?void 0:q.currentDate)==null?void 0:R.call(q))!=null?I:new Date;if(r!=null){const{value:N,responseHeaders:K}=await Xe({url:this.config.url({path:"/images/edits",modelId:this.modelId}),headers:se(this.config.headers(),f),formData:mt({model:this.modelId,prompt:t,image:await Promise.all(r.map(W=>W.type==="file"?new Blob([W.data instanceof Uint8Array?new Blob([W.data],{type:W.mediaType}):new Blob([xe(W.data)],{type:W.mediaType})],{type:W.mediaType}):Ye(W.url))),mask:m!=null?await Jt(m):void 0,n:p,size:d,...(x=c.openai)!=null?x:{}}),failedResponseHandler:le,successfulResponseHandler:_e(Ve),abortSignal:y,fetch:this.config.fetch});return{images:N.data.map(W=>W.b64_json),warnings:V,usage:N.usage!=null?{inputTokens:(S=N.usage.input_tokens)!=null?S:void 0,outputTokens:(O=N.usage.output_tokens)!=null?O:void 0,totalTokens:(h=N.usage.total_tokens)!=null?h:void 0}:void 0,response:{timestamp:n,modelId:this.modelId,headers:K},providerMetadata:{openai:{images:N.data.map(W=>{var b,_,T,P,g;return{...W.revised_prompt?{revisedPrompt:W.revised_prompt}:{},created:(b=N.created)!=null?b:void 0,size:(_=N.size)!=null?_:void 0,quality:(T=N.quality)!=null?T:void 0,background:(P=N.background)!=null?P:void 0,outputFormat:(g=N.output_format)!=null?g:void 0}})}}}}const{value:M,responseHeaders:B}=await de({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:se(this.config.headers(),f),body:{model:this.modelId,prompt:t,n:p,size:d,...(U=c.openai)!=null?U:{},...Vt(this.modelId)?{}:{response_format:"b64_json"}},failedResponseHandler:le,successfulResponseHandler:_e(Ve),abortSignal:y,fetch:this.config.fetch});return{images:M.data.map(N=>N.b64_json),warnings:V,usage:M.usage!=null?{inputTokens:(E=M.usage.input_tokens)!=null?E:void 0,outputTokens:(C=M.usage.output_tokens)!=null?C:void 0,totalTokens:(J=M.usage.total_tokens)!=null?J:void 0}:void 0,response:{timestamp:n,modelId:this.modelId,headers:B},providerMetadata:{openai:{images:M.data.map(N=>{var K,W,b,_,T;return{...N.revised_prompt?{revisedPrompt:N.revised_prompt}:{},created:(K=M.created)!=null?K:void 0,size:(W=M.size)!=null?W:void 0,quality:(b=M.quality)!=null?b:void 0,background:(_=M.background)!=null?_:void 0,outputFormat:(T=M.output_format)!=null?T:void 0}})}}}}};async function Jt(t){if(!t)return;if(t.type==="url")return Ye(t.url);const r=t.data instanceof Uint8Array?t.data:xe(t.data);return new Blob([r],{type:t.mediaType})}var tt=j(()=>D(o({callId:e(),operation:Z("type",[o({type:l("create_file"),path:e(),diff:e()}),o({type:l("delete_file"),path:e()}),o({type:l("update_file"),path:e(),diff:e()})])}))),ot=j(()=>D(o({status:H(["completed","failed"]),output:e().optional()}))),Lt=ce({id:"openai.apply_patch",inputSchema:tt,outputSchema:ot}),Ft=Lt,Bt=j(()=>D(o({code:e().nullish(),containerId:e()}))),Gt=j(()=>D(o({outputs:v(Z("type",[o({type:l("logs"),logs:e()}),o({type:l("image"),url:e()})])).nullish()}))),Kt=j(()=>D(o({container:F([e(),o({fileIds:v(e()).optional()})]).optional()}))),Zt=ce({id:"openai.code_interpreter",inputSchema:Bt,outputSchema:Gt}),Xt=(t={})=>Zt(t),at=o({key:e(),type:H(["eq","ne","gt","gte","lt","lte","in","nin"]),value:F([e(),s(),Q(),v(e())])}),nt=o({type:H(["and","or"]),filters:v(F([at,Qe(()=>nt)]))}),Yt=j(()=>D(o({vectorStoreIds:v(e()),maxNumResults:s().optional(),ranking:o({ranker:e().optional(),scoreThreshold:s().optional()}).optional(),filters:F([at,nt]).optional()}))),Qt=j(()=>D(o({queries:v(e()),results:v(o({attributes:ee(e(),ke()),fileId:e(),filename:e(),score:s(),text:e()})).nullable()}))),eo=ce({id:"openai.file_search",inputSchema:o({}),outputSchema:Qt}),to=j(()=>D(o({background:H(["auto","opaque","transparent"]).optional(),inputFidelity:H(["low","high"]).optional(),inputImageMask:o({fileId:e().optional(),imageUrl:e().optional()}).optional(),model:e().optional(),moderation:H(["auto"]).optional(),outputCompression:s().int().min(0).max(100).optional(),outputFormat:H(["png","jpeg","webp"]).optional(),partialImages:s().int().min(0).max(3).optional(),quality:H(["auto","low","medium","high"]).optional(),size:H(["1024x1024","1024x1536","1536x1024","auto"]).optional()}).strict())),oo=j(()=>D(o({}))),ao=j(()=>D(o({result:e()}))),no=ce({id:"openai.image_generation",inputSchema:oo,outputSchema:ao}),io=(t={})=>no(t),it=j(()=>D(o({action:o({type:l("exec"),command:v(e()),timeoutMs:s().optional(),user:e().optional(),workingDirectory:e().optional(),env:ee(e(),e()).optional()})}))),st=j(()=>D(o({output:e()}))),so=ce({id:"openai.local_shell",inputSchema:it,outputSchema:st}),lt=j(()=>D(o({action:o({commands:v(e()),timeoutMs:s().optional(),maxOutputLength:s().optional()})}))),rt=j(()=>D(o({output:v(o({stdout:e(),stderr:e(),outcome:Z("type",[o({type:l("timeout")}),o({type:l("exit"),exitCode:s()})])}))}))),lo=ce({id:"openai.shell",inputSchema:lt,outputSchema:rt}),ro=j(()=>D(o({externalWebAccess:Q().optional(),filters:o({allowedDomains:v(e()).optional()}).optional(),searchContextSize:H(["low","medium","high"]).optional(),userLocation:o({type:l("approximate"),country:e().optional(),city:e().optional(),region:e().optional(),timezone:e().optional()}).optional()}))),po=j(()=>D(o({}))),uo=j(()=>D(o({action:Z("type",[o({type:l("search"),query:e().optional()}),o({type:l("openPage"),url:e().nullish()}),o({type:l("findInPage"),url:e().nullish(),pattern:e().nullish()})]),sources:v(Z("type",[o({type:l("url"),url:e()}),o({type:l("api"),name:e()})])).optional()}))),co=ce({id:"openai.web_search",inputSchema:po,outputSchema:uo}),mo=(t={})=>co(t),ho=j(()=>D(o({searchContextSize:H(["low","medium","high"]).optional(),userLocation:o({type:l("approximate"),country:e().optional(),city:e().optional(),region:e().optional(),timezone:e().optional()}).optional()}))),_o=j(()=>D(o({}))),fo=j(()=>D(o({action:Z("type",[o({type:l("search"),query:e().optional()}),o({type:l("openPage"),url:e().nullish()}),o({type:l("findInPage"),url:e().nullish(),pattern:e().nullish()})])}))),yo=ce({id:"openai.web_search_preview",inputSchema:_o,outputSchema:fo}),we=Qe(()=>F([e(),s(),Q(),Ct(),v(we),ee(e(),we)])),go=j(()=>D(o({serverLabel:e(),allowedTools:F([v(e()),o({readOnly:Q().optional(),toolNames:v(e()).optional()})]).optional(),authorization:e().optional(),connectorId:e().optional(),headers:ee(e(),e()).optional(),requireApproval:F([H(["always","never"]),o({never:o({toolNames:v(e()).optional()}).optional()})]).optional(),serverDescription:e().optional(),serverUrl:e().optional()}).refine(t=>t.serverUrl!=null||t.connectorId!=null,"One of serverUrl or connectorId must be provided."))),vo=j(()=>D(o({}))),bo=j(()=>D(o({type:l("call"),serverLabel:e(),name:e(),arguments:e(),output:e().nullish(),error:F([e(),we]).optional()}))),wo=ce({id:"openai.mcp",inputSchema:vo,outputSchema:bo}),xo=t=>wo(t),Io={applyPatch:Ft,codeInterpreter:Xt,fileSearch:eo,imageGeneration:io,localShell:so,shell:lo,webSearchPreview:yo,webSearch:mo,mcp:xo};function ze(t){var r,m,p,d;if(t==null)return{inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0},raw:void 0};const u=t.input_tokens,i=t.output_tokens,c=(m=(r=t.input_tokens_details)==null?void 0:r.cached_tokens)!=null?m:0,f=(d=(p=t.output_tokens_details)==null?void 0:p.reasoning_tokens)!=null?d:0;return{inputTokens:{total:u,noCache:u-c,cacheRead:c,cacheWrite:void 0},outputTokens:{total:i,text:i-f,reasoning:f},raw:t}}function Je(t,r){return r?r.some(m=>t.startsWith(m)):!1}async function ko({prompt:t,toolNameMapping:r,systemMessageMode:m,providerOptionsName:p,fileIdPrefixes:d,store:u,hasConversation:i=!1,hasLocalShellTool:c=!1,hasShellTool:f=!1,hasApplyPatchTool:y=!1}){var q,R,I,x,S,O,h,U,E,C,J,V,n;const M=[],B=[],N=new Set;for(const{role:K,content:W}of t)switch(K){case"system":{switch(m){case"system":{M.push({role:"system",content:W});break}case"developer":{M.push({role:"developer",content:W});break}case"remove":{B.push({type:"other",message:"system messages are removed for this model"});break}default:{const b=m;throw new Error(`Unsupported system message mode: ${b}`)}}break}case"user":{M.push({role:"user",content:W.map((b,_)=>{var T,P,g;switch(b.type){case"text":return{type:"input_text",text:b.text};case"file":if(b.mediaType.startsWith("image/")){const z=b.mediaType==="image/*"?"image/jpeg":b.mediaType;return{type:"input_image",...b.data instanceof URL?{image_url:b.data.toString()}:typeof b.data=="string"&&Je(b.data,d)?{file_id:b.data}:{image_url:`data:${z};base64,${fe(b.data)}`},detail:(P=(T=b.providerOptions)==null?void 0:T[p])==null?void 0:P.imageDetail}}else{if(b.mediaType==="application/pdf")return b.data instanceof URL?{type:"input_file",file_url:b.data.toString()}:{type:"input_file",...typeof b.data=="string"&&Je(b.data,d)?{file_id:b.data}:{filename:(g=b.filename)!=null?g:`part-${_}.pdf`,file_data:`data:application/pdf;base64,${fe(b.data)}`}};throw new pe({functionality:`file part media type ${b.mediaType}`})}}})});break}case"assistant":{const b={};for(const _ of W)switch(_.type){case"text":{const T=(R=(q=_.providerOptions)==null?void 0:q[p])==null?void 0:R.itemId;if(i&&T!=null)break;if(u&&T!=null){M.push({type:"item_reference",id:T});break}M.push({role:"assistant",content:[{type:"output_text",text:_.text}],id:T});break}case"tool-call":{const T=(h=(x=(I=_.providerOptions)==null?void 0:I[p])==null?void 0:x.itemId)!=null?h:(O=(S=_.providerMetadata)==null?void 0:S[p])==null?void 0:O.itemId;if(i&&T!=null)break;if(_.providerExecuted){u&&T!=null&&M.push({type:"item_reference",id:T});break}if(u&&T!=null){M.push({type:"item_reference",id:T});break}const P=r.toProviderToolName(_.toolName);if(c&&P==="local_shell"){const g=await ne({value:_.input,schema:it});M.push({type:"local_shell_call",call_id:_.toolCallId,id:T,action:{type:"exec",command:g.action.command,timeout_ms:g.action.timeoutMs,user:g.action.user,working_directory:g.action.workingDirectory,env:g.action.env}});break}if(f&&P==="shell"){const g=await ne({value:_.input,schema:lt});M.push({type:"shell_call",call_id:_.toolCallId,id:T,status:"completed",action:{commands:g.action.commands,timeout_ms:g.action.timeoutMs,max_output_length:g.action.maxOutputLength}});break}if(y&&P==="apply_patch"){const g=await ne({value:_.input,schema:tt});M.push({type:"apply_patch_call",call_id:g.callId,id:T,status:"completed",operation:g.operation});break}M.push({type:"function_call",call_id:_.toolCallId,name:P,arguments:JSON.stringify(_.input),id:T});break}case"tool-result":{if(_.output.type==="execution-denied"||_.output.type==="json"&&typeof _.output.value=="object"&&_.output.value!=null&&"type"in _.output.value&&_.output.value.type==="execution-denied"||i)break;if(u){const T=(C=(E=(U=_.providerMetadata)==null?void 0:U[p])==null?void 0:E.itemId)!=null?C:_.toolCallId;M.push({type:"item_reference",id:T})}else B.push({type:"other",message:`Results for OpenAI tool ${_.toolName} are not sent to the API when store is false`});break}case"reasoning":{const T=await ue({provider:p,providerOptions:_.providerOptions,schema:Co}),P=T?.itemId;if(i&&P!=null)break;if(P!=null){const g=b[P];if(u)g===void 0&&(M.push({type:"item_reference",id:P}),b[P]={type:"reasoning",id:P,summary:[]});else{const z=[];_.text.length>0?z.push({type:"summary_text",text:_.text}):g!==void 0&&B.push({type:"other",message:`Cannot append empty reasoning part to existing reasoning sequence. Skipping reasoning part: ${JSON.stringify(_)}.`}),g===void 0?(b[P]={type:"reasoning",id:P,encrypted_content:T?.reasoningEncryptedContent,summary:z},M.push(b[P])):(g.summary.push(...z),T?.reasoningEncryptedContent!=null&&(g.encrypted_content=T.reasoningEncryptedContent))}}else B.push({type:"other",message:`Non-OpenAI reasoning parts are not supported. Skipping reasoning part: ${JSON.stringify(_)}.`});break}}break}case"tool":{for(const b of W){if(b.type==="tool-approval-response"){const g=b;if(N.has(g.approvalId))continue;N.add(g.approvalId),u&&M.push({type:"item_reference",id:g.approvalId}),M.push({type:"mcp_approval_response",approval_request_id:g.approvalId,approve:g.approved});continue}const _=b.output;if(_.type==="execution-denied"&&((V=(J=_.providerOptions)==null?void 0:J.openai)==null?void 0:V.approvalId))continue;const T=r.toProviderToolName(b.toolName);if(c&&T==="local_shell"&&_.type==="json"){const g=await ne({value:_.value,schema:st});M.push({type:"local_shell_call_output",call_id:b.toolCallId,output:g.output});continue}if(f&&T==="shell"&&_.type==="json"){const g=await ne({value:_.value,schema:rt});M.push({type:"shell_call_output",call_id:b.toolCallId,output:g.output.map(z=>({stdout:z.stdout,stderr:z.stderr,outcome:z.outcome.type==="timeout"?{type:"timeout"}:{type:"exit",exit_code:z.outcome.exitCode}}))});continue}if(y&&b.toolName==="apply_patch"&&_.type==="json"){const g=await ne({value:_.value,schema:ot});M.push({type:"apply_patch_call_output",call_id:b.toolCallId,status:g.status,output:g.output});continue}let P;switch(_.type){case"text":case"error-text":P=_.value;break;case"execution-denied":P=(n=_.reason)!=null?n:"Tool execution denied.";break;case"json":case"error-json":P=JSON.stringify(_.value);break;case"content":P=_.value.map(g=>{var z;switch(g.type){case"text":return{type:"input_text",text:g.text};case"image-data":return{type:"input_image",image_url:`data:${g.mediaType};base64,${g.data}`};case"image-url":return{type:"input_image",image_url:g.url};case"file-data":return{type:"input_file",filename:(z=g.filename)!=null?z:"data",file_data:`data:${g.mediaType};base64,${g.data}`};default:{B.push({type:"other",message:`unsupported tool content part type: ${g.type}`});return}}}).filter(xt);break}M.push({type:"function_call_output",call_id:b.toolCallId,output:P})}break}default:{const b=K;throw new Error(`Unsupported role: ${b}`)}}return{input:M,warnings:B}}var Co=o({itemId:e().nullish(),reasoningEncryptedContent:e().nullish()});function Le({finishReason:t,hasFunctionCall:r}){switch(t){case void 0:case null:return r?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return r?"tool-calls":"other"}}var To=j(()=>D(F([o({type:l("response.output_text.delta"),item_id:e(),delta:e(),logprobs:v(o({token:e(),logprob:s(),top_logprobs:v(o({token:e(),logprob:s()}))})).nullish()}),o({type:H(["response.completed","response.incomplete"]),response:o({incomplete_details:o({reason:e()}).nullish(),usage:o({input_tokens:s(),input_tokens_details:o({cached_tokens:s().nullish()}).nullish(),output_tokens:s(),output_tokens_details:o({reasoning_tokens:s().nullish()}).nullish()}),service_tier:e().nullish()})}),o({type:l("response.created"),response:o({id:e(),created_at:s(),model:e(),service_tier:e().nullish()})}),o({type:l("response.output_item.added"),output_index:s(),item:Z("type",[o({type:l("message"),id:e()}),o({type:l("reasoning"),id:e(),encrypted_content:e().nullish()}),o({type:l("function_call"),id:e(),call_id:e(),name:e(),arguments:e()}),o({type:l("web_search_call"),id:e(),status:e()}),o({type:l("computer_call"),id:e(),status:e()}),o({type:l("file_search_call"),id:e()}),o({type:l("image_generation_call"),id:e()}),o({type:l("code_interpreter_call"),id:e(),container_id:e(),code:e().nullable(),outputs:v(Z("type",[o({type:l("logs"),logs:e()}),o({type:l("image"),url:e()})])).nullable(),status:e()}),o({type:l("mcp_call"),id:e(),status:e(),approval_request_id:e().nullish()}),o({type:l("mcp_list_tools"),id:e()}),o({type:l("mcp_approval_request"),id:e()}),o({type:l("apply_patch_call"),id:e(),call_id:e(),status:H(["in_progress","completed"]),operation:Z("type",[o({type:l("create_file"),path:e(),diff:e()}),o({type:l("delete_file"),path:e()}),o({type:l("update_file"),path:e(),diff:e()})])}),o({type:l("shell_call"),id:e(),call_id:e(),status:H(["in_progress","completed","incomplete"]),action:o({commands:v(e())})})])}),o({type:l("response.output_item.done"),output_index:s(),item:Z("type",[o({type:l("message"),id:e()}),o({type:l("reasoning"),id:e(),encrypted_content:e().nullish()}),o({type:l("function_call"),id:e(),call_id:e(),name:e(),arguments:e(),status:l("completed")}),o({type:l("code_interpreter_call"),id:e(),code:e().nullable(),container_id:e(),outputs:v(Z("type",[o({type:l("logs"),logs:e()}),o({type:l("image"),url:e()})])).nullable()}),o({type:l("image_generation_call"),id:e(),result:e()}),o({type:l("web_search_call"),id:e(),status:e(),action:Z("type",[o({type:l("search"),query:e().nullish(),sources:v(Z("type",[o({type:l("url"),url:e()}),o({type:l("api"),name:e()})])).nullish()}),o({type:l("open_page"),url:e().nullish()}),o({type:l("find_in_page"),url:e().nullish(),pattern:e().nullish()})])}),o({type:l("file_search_call"),id:e(),queries:v(e()),results:v(o({attributes:ee(e(),F([e(),s(),Q()])),file_id:e(),filename:e(),score:s(),text:e()})).nullish()}),o({type:l("local_shell_call"),id:e(),call_id:e(),action:o({type:l("exec"),command:v(e()),timeout_ms:s().optional(),user:e().optional(),working_directory:e().optional(),env:ee(e(),e()).optional()})}),o({type:l("computer_call"),id:e(),status:l("completed")}),o({type:l("mcp_call"),id:e(),status:e(),arguments:e(),name:e(),server_label:e(),output:e().nullish(),error:F([e(),o({type:e().optional(),code:F([s(),e()]).optional(),message:e().optional()}).loose()]).nullish(),approval_request_id:e().nullish()}),o({type:l("mcp_list_tools"),id:e(),server_label:e(),tools:v(o({name:e(),description:e().optional(),input_schema:ye(),annotations:ee(e(),ke()).optional()})),error:F([e(),o({type:e().optional(),code:F([s(),e()]).optional(),message:e().optional()}).loose()]).optional()}),o({type:l("mcp_approval_request"),id:e(),server_label:e(),name:e(),arguments:e(),approval_request_id:e().optional()}),o({type:l("apply_patch_call"),id:e(),call_id:e(),status:H(["in_progress","completed"]),operation:Z("type",[o({type:l("create_file"),path:e(),diff:e()}),o({type:l("delete_file"),path:e()}),o({type:l("update_file"),path:e(),diff:e()})])}),o({type:l("shell_call"),id:e(),call_id:e(),status:H(["in_progress","completed","incomplete"]),action:o({commands:v(e())})})])}),o({type:l("response.function_call_arguments.delta"),item_id:e(),output_index:s(),delta:e()}),o({type:l("response.image_generation_call.partial_image"),item_id:e(),output_index:s(),partial_image_b64:e()}),o({type:l("response.code_interpreter_call_code.delta"),item_id:e(),output_index:s(),delta:e()}),o({type:l("response.code_interpreter_call_code.done"),item_id:e(),output_index:s(),code:e()}),o({type:l("response.output_text.annotation.added"),annotation:Z("type",[o({type:l("url_citation"),start_index:s(),end_index:s(),url:e(),title:e()}),o({type:l("file_citation"),file_id:e(),filename:e(),index:s()}),o({type:l("container_file_citation"),container_id:e(),file_id:e(),filename:e(),start_index:s(),end_index:s()}),o({type:l("file_path"),file_id:e(),index:s()})])}),o({type:l("response.reasoning_summary_part.added"),item_id:e(),summary_index:s()}),o({type:l("response.reasoning_summary_text.delta"),item_id:e(),summary_index:s(),delta:e()}),o({type:l("response.reasoning_summary_part.done"),item_id:e(),summary_index:s()}),o({type:l("response.apply_patch_call_operation_diff.delta"),item_id:e(),output_index:s(),delta:e(),obfuscation:e().nullish()}),o({type:l("response.apply_patch_call_operation_diff.done"),item_id:e(),output_index:s(),diff:e()}),o({type:l("error"),sequence_number:s(),error:o({type:e(),code:e(),message:e(),param:e().nullish()})}),o({type:e()}).loose().transform(t=>({type:"unknown_chunk",message:t.type}))]))),qo=j(()=>D(o({id:e().optional(),created_at:s().optional(),error:o({message:e(),type:e(),param:e().nullish(),code:e()}).nullish(),model:e().optional(),output:v(Z("type",[o({type:l("message"),role:l("assistant"),id:e(),content:v(o({type:l("output_text"),text:e(),logprobs:v(o({token:e(),logprob:s(),top_logprobs:v(o({token:e(),logprob:s()}))})).nullish(),annotations:v(Z("type",[o({type:l("url_citation"),start_index:s(),end_index:s(),url:e(),title:e()}),o({type:l("file_citation"),file_id:e(),filename:e(),index:s()}),o({type:l("container_file_citation"),container_id:e(),file_id:e(),filename:e(),start_index:s(),end_index:s()}),o({type:l("file_path"),file_id:e(),index:s()})]))}))}),o({type:l("web_search_call"),id:e(),status:e(),action:Z("type",[o({type:l("search"),query:e().nullish(),sources:v(Z("type",[o({type:l("url"),url:e()}),o({type:l("api"),name:e()})])).nullish()}),o({type:l("open_page"),url:e().nullish()}),o({type:l("find_in_page"),url:e().nullish(),pattern:e().nullish()})])}),o({type:l("file_search_call"),id:e(),queries:v(e()),results:v(o({attributes:ee(e(),F([e(),s(),Q()])),file_id:e(),filename:e(),score:s(),text:e()})).nullish()}),o({type:l("code_interpreter_call"),id:e(),code:e().nullable(),container_id:e(),outputs:v(Z("type",[o({type:l("logs"),logs:e()}),o({type:l("image"),url:e()})])).nullable()}),o({type:l("image_generation_call"),id:e(),result:e()}),o({type:l("local_shell_call"),id:e(),call_id:e(),action:o({type:l("exec"),command:v(e()),timeout_ms:s().optional(),user:e().optional(),working_directory:e().optional(),env:ee(e(),e()).optional()})}),o({type:l("function_call"),call_id:e(),name:e(),arguments:e(),id:e()}),o({type:l("computer_call"),id:e(),status:e().optional()}),o({type:l("reasoning"),id:e(),encrypted_content:e().nullish(),summary:v(o({type:l("summary_text"),text:e()}))}),o({type:l("mcp_call"),id:e(),status:e(),arguments:e(),name:e(),server_label:e(),output:e().nullish(),error:F([e(),o({type:e().optional(),code:F([s(),e()]).optional(),message:e().optional()}).loose()]).nullish(),approval_request_id:e().nullish()}),o({type:l("mcp_list_tools"),id:e(),server_label:e(),tools:v(o({name:e(),description:e().optional(),input_schema:ye(),annotations:ee(e(),ke()).optional()})),error:F([e(),o({type:e().optional(),code:F([s(),e()]).optional(),message:e().optional()}).loose()]).optional()}),o({type:l("mcp_approval_request"),id:e(),server_label:e(),name:e(),arguments:e(),approval_request_id:e().optional()}),o({type:l("apply_patch_call"),id:e(),call_id:e(),status:H(["in_progress","completed"]),operation:Z("type",[o({type:l("create_file"),path:e(),diff:e()}),o({type:l("delete_file"),path:e()}),o({type:l("update_file"),path:e(),diff:e()})])}),o({type:l("shell_call"),id:e(),call_id:e(),status:H(["in_progress","completed","incomplete"]),action:o({commands:v(e())})})])).optional(),service_tier:e().nullish(),incomplete_details:o({reason:e()}).nullish(),usage:o({input_tokens:s(),input_tokens_details:o({cached_tokens:s().nullish()}).nullish(),output_tokens:s(),output_tokens_details:o({reasoning_tokens:s().nullish()}).nullish()}).optional()}))),pt=20,Fe=j(()=>D(o({conversation:e().nullish(),include:v(H(["reasoning.encrypted_content","file_search_call.results","message.output_text.logprobs"])).nullish(),instructions:e().nullish(),logprobs:F([Q(),s().min(1).max(pt)]).optional(),maxToolCalls:s().nullish(),metadata:ye().nullish(),parallelToolCalls:Q().nullish(),previousResponseId:e().nullish(),promptCacheKey:e().nullish(),promptCacheRetention:H(["in_memory","24h"]).nullish(),reasoningEffort:e().nullish(),reasoningSummary:e().nullish(),safetyIdentifier:e().nullish(),serviceTier:H(["auto","flex","priority","default"]).nullish(),store:Q().nullish(),strictJsonSchema:Q().nullish(),textVerbosity:H(["low","medium","high"]).nullish(),truncation:H(["auto","disabled"]).nullish(),user:e().nullish(),systemMessageMode:H(["system","developer","remove"]).optional(),forceReasoning:Q().optional()})));async function So({tools:t,toolChoice:r}){t=t?.length?t:void 0;const m=[];if(t==null)return{tools:void 0,toolChoice:void 0,toolWarnings:m};const p=[];for(const u of t)switch(u.type){case"function":p.push({type:"function",name:u.name,description:u.description,parameters:u.inputSchema,...u.strict!=null?{strict:u.strict}:{}});break;case"provider":{switch(u.id){case"openai.file_search":{const i=await ne({value:u.args,schema:Yt});p.push({type:"file_search",vector_store_ids:i.vectorStoreIds,max_num_results:i.maxNumResults,ranking_options:i.ranking?{ranker:i.ranking.ranker,score_threshold:i.ranking.scoreThreshold}:void 0,filters:i.filters});break}case"openai.local_shell":{p.push({type:"local_shell"});break}case"openai.shell":{p.push({type:"shell"});break}case"openai.apply_patch":{p.push({type:"apply_patch"});break}case"openai.web_search_preview":{const i=await ne({value:u.args,schema:ho});p.push({type:"web_search_preview",search_context_size:i.searchContextSize,user_location:i.userLocation});break}case"openai.web_search":{const i=await ne({value:u.args,schema:ro});p.push({type:"web_search",filters:i.filters!=null?{allowed_domains:i.filters.allowedDomains}:void 0,external_web_access:i.externalWebAccess,search_context_size:i.searchContextSize,user_location:i.userLocation});break}case"openai.code_interpreter":{const i=await ne({value:u.args,schema:Kt});p.push({type:"code_interpreter",container:i.container==null?{type:"auto",file_ids:void 0}:typeof i.container=="string"?i.container:{type:"auto",file_ids:i.container.fileIds}});break}case"openai.image_generation":{const i=await ne({value:u.args,schema:to});p.push({type:"image_generation",background:i.background,input_fidelity:i.inputFidelity,input_image_mask:i.inputImageMask?{file_id:i.inputImageMask.fileId,image_url:i.inputImageMask.imageUrl}:void 0,model:i.model,moderation:i.moderation,partial_images:i.partialImages,quality:i.quality,output_compression:i.outputCompression,output_format:i.outputFormat,size:i.size});break}case"openai.mcp":{const i=await ne({value:u.args,schema:go}),c=q=>({tool_names:q.toolNames}),f=i.requireApproval,y=f==null?void 0:typeof f=="string"?f:f.never!=null?{never:c(f.never)}:void 0;p.push({type:"mcp",server_label:i.serverLabel,allowed_tools:Array.isArray(i.allowedTools)?i.allowedTools:i.allowedTools?{read_only:i.allowedTools.readOnly,tool_names:i.allowedTools.toolNames}:void 0,authorization:i.authorization,connector_id:i.connectorId,headers:i.headers,require_approval:y??"never",server_description:i.serverDescription,server_url:i.serverUrl});break}}break}default:m.push({type:"unsupported",feature:`function tool ${u}`});break}if(r==null)return{tools:p,toolChoice:void 0,toolWarnings:m};const d=r.type;switch(d){case"auto":case"none":case"required":return{tools:p,toolChoice:d,toolWarnings:m};case"tool":return{tools:p,toolChoice:r.toolName==="code_interpreter"||r.toolName==="file_search"||r.toolName==="image_generation"||r.toolName==="web_search_preview"||r.toolName==="web_search"||r.toolName==="mcp"||r.toolName==="apply_patch"?{type:r.toolName}:{type:"function",name:r.toolName},toolWarnings:m};default:{const u=d;throw new pe({functionality:`tool choice type: ${u}`})}}}function Be(t){var r,m;const p={};for(const d of t)if(d.role==="assistant")for(const u of d.content){if(u.type!=="tool-call")continue;const i=(m=(r=u.providerOptions)==null?void 0:r.openai)==null?void 0:m.approvalRequestId;i!=null&&(p[i]=u.toolCallId)}return p}var No=class{constructor(t,r){this.specificationVersion="v3",this.supportedUrls={"image/*":[/^https?:\/\/.*$/],"application/pdf":[/^https?:\/\/.*$/]},this.modelId=t,this.config=r}get provider(){return this.config.provider}async getArgs({maxOutputTokens:t,temperature:r,stopSequences:m,topP:p,topK:d,presencePenalty:u,frequencyPenalty:i,seed:c,prompt:f,providerOptions:y,tools:q,toolChoice:R,responseFormat:I}){var x,S,O,h,U,E;const C=[],J=et(this.modelId);d!=null&&C.push({type:"unsupported",feature:"topK"}),c!=null&&C.push({type:"unsupported",feature:"seed"}),u!=null&&C.push({type:"unsupported",feature:"presencePenalty"}),i!=null&&C.push({type:"unsupported",feature:"frequencyPenalty"}),m!=null&&C.push({type:"unsupported",feature:"stopSequences"});const V=this.config.provider.includes("azure")?"azure":"openai";let n=await ue({provider:V,providerOptions:y,schema:Fe});n==null&&V!=="openai"&&(n=await ue({provider:"openai",providerOptions:y,schema:Fe}));const M=(x=n?.forceReasoning)!=null?x:J.isReasoningModel;n?.conversation&&n?.previousResponseId&&C.push({type:"unsupported",feature:"conversation",details:"conversation and previousResponseId cannot be used together"});const B=gt({tools:q,providerToolNames:{"openai.code_interpreter":"code_interpreter","openai.file_search":"file_search","openai.image_generation":"image_generation","openai.local_shell":"local_shell","openai.shell":"shell","openai.web_search":"web_search","openai.web_search_preview":"web_search_preview","openai.mcp":"mcp","openai.apply_patch":"apply_patch"}}),{input:N,warnings:K}=await ko({prompt:f,toolNameMapping:B,systemMessageMode:(S=n?.systemMessageMode)!=null?S:M?"developer":J.systemMessageMode,providerOptionsName:V,fileIdPrefixes:this.config.fileIdPrefixes,store:(O=n?.store)!=null?O:!0,hasConversation:n?.conversation!=null,hasLocalShellTool:T("openai.local_shell"),hasShellTool:T("openai.shell"),hasApplyPatchTool:T("openai.apply_patch")});C.push(...K);const W=(h=n?.strictJsonSchema)!=null?h:!0;let b=n?.include;function _(te){b==null?b=[te]:b.includes(te)||(b=[...b,te])}function T(te){return q?.find(me=>me.type==="provider"&&me.id===te)!=null}const P=typeof n?.logprobs=="number"?n?.logprobs:n?.logprobs===!0?pt:void 0;P&&_("message.output_text.logprobs");const g=(U=q?.find(te=>te.type==="provider"&&(te.id==="openai.web_search"||te.id==="openai.web_search_preview")))==null?void 0:U.name;g&&_("web_search_call.action.sources"),T("openai.code_interpreter")&&_("code_interpreter_call.outputs");const z=n?.store;z===!1&&M&&_("reasoning.encrypted_content");const A={model:this.modelId,input:N,temperature:r,top_p:p,max_output_tokens:t,...(I?.type==="json"||n?.textVerbosity)&&{text:{...I?.type==="json"&&{format:I.schema!=null?{type:"json_schema",strict:W,name:(E=I.name)!=null?E:"response",description:I.description,schema:I.schema}:{type:"json_object"}},...n?.textVerbosity&&{verbosity:n.textVerbosity}}},conversation:n?.conversation,max_tool_calls:n?.maxToolCalls,metadata:n?.metadata,parallel_tool_calls:n?.parallelToolCalls,previous_response_id:n?.previousResponseId,store:z,user:n?.user,instructions:n?.instructions,service_tier:n?.serviceTier,include:b,prompt_cache_key:n?.promptCacheKey,prompt_cache_retention:n?.promptCacheRetention,safety_identifier:n?.safetyIdentifier,top_logprobs:P,truncation:n?.truncation,...M&&(n?.reasoningEffort!=null||n?.reasoningSummary!=null)&&{reasoning:{...n?.reasoningEffort!=null&&{effort:n.reasoningEffort},...n?.reasoningSummary!=null&&{summary:n.reasoningSummary}}}};M?n?.reasoningEffort==="none"&&J.supportsNonReasoningParameters||(A.temperature!=null&&(A.temperature=void 0,C.push({type:"unsupported",feature:"temperature",details:"temperature is not supported for reasoning models"})),A.top_p!=null&&(A.top_p=void 0,C.push({type:"unsupported",feature:"topP",details:"topP is not supported for reasoning models"}))):(n?.reasoningEffort!=null&&C.push({type:"unsupported",feature:"reasoningEffort",details:"reasoningEffort is not supported for non-reasoning models"}),n?.reasoningSummary!=null&&C.push({type:"unsupported",feature:"reasoningSummary",details:"reasoningSummary is not supported for non-reasoning models"})),n?.serviceTier==="flex"&&!J.supportsFlexProcessing&&(C.push({type:"unsupported",feature:"serviceTier",details:"flex processing is only available for o3, o4-mini, and gpt-5 models"}),delete A.service_tier),n?.serviceTier==="priority"&&!J.supportsPriorityProcessing&&(C.push({type:"unsupported",feature:"serviceTier",details:"priority processing is only available for supported models (gpt-4, gpt-5, gpt-5-mini, o3, o4-mini) and requires Enterprise access. gpt-5-nano is not supported"}),delete A.service_tier);const{tools:ae,toolChoice:$,toolWarnings:X}=await So({tools:q,toolChoice:R});return{webSearchToolName:g,args:{...A,tools:ae,tool_choice:$},warnings:[...C,...X],store:z,toolNameMapping:B,providerOptionsName:V}}async doGenerate(t){var r,m,p,d,u,i,c,f,y,q,R,I,x,S,O,h,U,E,C,J,V,n,M,B,N;const{args:K,warnings:W,webSearchToolName:b,toolNameMapping:_,providerOptionsName:T}=await this.getArgs(t),P=this.config.url({path:"/responses",modelId:this.modelId}),g=Be(t.prompt),{responseHeaders:z,value:A,rawValue:ae}=await de({url:P,headers:se(this.config.headers(),t.headers),body:K,failedResponseHandler:le,successfulResponseHandler:_e(qo),abortSignal:t.abortSignal,fetch:this.config.fetch});if(A.error)throw new vt({message:A.error.message,url:P,requestBodyValues:K,statusCode:400,responseHeaders:z,responseBody:ae,isRetryable:!1});const $=[],X=[];let te=!1;for(const k of A.output)switch(k.type){case"reasoning":{k.summary.length===0&&k.summary.push({type:"summary_text",text:""});for(const G of k.summary)$.push({type:"reasoning",text:G.text,providerMetadata:{[T]:{itemId:k.id,reasoningEncryptedContent:(r=k.encrypted_content)!=null?r:null}}});break}case"image_generation_call":{$.push({type:"tool-call",toolCallId:k.id,toolName:_.toCustomToolName("image_generation"),input:"{}",providerExecuted:!0}),$.push({type:"tool-result",toolCallId:k.id,toolName:_.toCustomToolName("image_generation"),result:{result:k.result}});break}case"local_shell_call":{$.push({type:"tool-call",toolCallId:k.call_id,toolName:_.toCustomToolName("local_shell"),input:JSON.stringify({action:k.action}),providerMetadata:{[T]:{itemId:k.id}}});break}case"shell_call":{$.push({type:"tool-call",toolCallId:k.call_id,toolName:_.toCustomToolName("shell"),input:JSON.stringify({action:{commands:k.action.commands}}),providerMetadata:{[T]:{itemId:k.id}}});break}case"message":{for(const G of k.content){(p=(m=t.providerOptions)==null?void 0:m[T])!=null&&p.logprobs&&G.logprobs&&X.push(G.logprobs);const re={itemId:k.id,...G.annotations.length>0&&{annotations:G.annotations}};$.push({type:"text",text:G.text,providerMetadata:{[T]:re}});for(const L of G.annotations)L.type==="url_citation"?$.push({type:"source",sourceType:"url",id:(i=(u=(d=this.config).generateId)==null?void 0:u.call(d))!=null?i:oe(),url:L.url,title:L.title}):L.type==="file_citation"?$.push({type:"source",sourceType:"document",id:(y=(f=(c=this.config).generateId)==null?void 0:f.call(c))!=null?y:oe(),mediaType:"text/plain",title:L.filename,filename:L.filename,providerMetadata:{[T]:{type:L.type,fileId:L.file_id,index:L.index}}}):L.type==="container_file_citation"?$.push({type:"source",sourceType:"document",id:(I=(R=(q=this.config).generateId)==null?void 0:R.call(q))!=null?I:oe(),mediaType:"text/plain",title:L.filename,filename:L.filename,providerMetadata:{[T]:{type:L.type,fileId:L.file_id,containerId:L.container_id}}}):L.type==="file_path"&&$.push({type:"source",sourceType:"document",id:(O=(S=(x=this.config).generateId)==null?void 0:S.call(x))!=null?O:oe(),mediaType:"application/octet-stream",title:L.file_id,filename:L.file_id,providerMetadata:{[T]:{type:L.type,fileId:L.file_id,index:L.index}}})}break}case"function_call":{te=!0,$.push({type:"tool-call",toolCallId:k.call_id,toolName:k.name,input:k.arguments,providerMetadata:{[T]:{itemId:k.id}}});break}case"web_search_call":{$.push({type:"tool-call",toolCallId:k.id,toolName:_.toCustomToolName(b??"web_search"),input:JSON.stringify({}),providerExecuted:!0}),$.push({type:"tool-result",toolCallId:k.id,toolName:_.toCustomToolName(b??"web_search"),result:Ke(k.action)});break}case"mcp_call":{const G=k.approval_request_id!=null&&(h=g[k.approval_request_id])!=null?h:k.id,re=`mcp.${k.name}`;$.push({type:"tool-call",toolCallId:G,toolName:re,input:k.arguments,providerExecuted:!0,dynamic:!0}),$.push({type:"tool-result",toolCallId:G,toolName:re,result:{type:"call",serverLabel:k.server_label,name:k.name,arguments:k.arguments,...k.output!=null?{output:k.output}:{},...k.error!=null?{error:k.error}:{}},providerMetadata:{[T]:{itemId:k.id}}});break}case"mcp_list_tools":break;case"mcp_approval_request":{const G=(U=k.approval_request_id)!=null?U:k.id,re=(J=(C=(E=this.config).generateId)==null?void 0:C.call(E))!=null?J:oe(),L=`mcp.${k.name}`;$.push({type:"tool-call",toolCallId:re,toolName:L,input:k.arguments,providerExecuted:!0,dynamic:!0}),$.push({type:"tool-approval-request",approvalId:G,toolCallId:re});break}case"computer_call":{$.push({type:"tool-call",toolCallId:k.id,toolName:_.toCustomToolName("computer_use"),input:"",providerExecuted:!0}),$.push({type:"tool-result",toolCallId:k.id,toolName:_.toCustomToolName("computer_use"),result:{type:"computer_use_tool_result",status:k.status||"completed"}});break}case"file_search_call":{$.push({type:"tool-call",toolCallId:k.id,toolName:_.toCustomToolName("file_search"),input:"{}",providerExecuted:!0}),$.push({type:"tool-result",toolCallId:k.id,toolName:_.toCustomToolName("file_search"),result:{queries:k.queries,results:(n=(V=k.results)==null?void 0:V.map(G=>({attributes:G.attributes,fileId:G.file_id,filename:G.filename,score:G.score,text:G.text})))!=null?n:null}});break}case"code_interpreter_call":{$.push({type:"tool-call",toolCallId:k.id,toolName:_.toCustomToolName("code_interpreter"),input:JSON.stringify({code:k.code,containerId:k.container_id}),providerExecuted:!0}),$.push({type:"tool-result",toolCallId:k.id,toolName:_.toCustomToolName("code_interpreter"),result:{outputs:k.outputs}});break}case"apply_patch_call":{$.push({type:"tool-call",toolCallId:k.call_id,toolName:_.toCustomToolName("apply_patch"),input:JSON.stringify({callId:k.call_id,operation:k.operation}),providerMetadata:{[T]:{itemId:k.id}}});break}}const me={[T]:{responseId:A.id,...X.length>0?{logprobs:X}:{},...typeof A.service_tier=="string"?{serviceTier:A.service_tier}:{}}},ge=A.usage;return{content:$,finishReason:{unified:Le({finishReason:(M=A.incomplete_details)==null?void 0:M.reason,hasFunctionCall:te}),raw:(N=(B=A.incomplete_details)==null?void 0:B.reason)!=null?N:void 0},usage:ze(ge),request:{body:K},response:{id:A.id,timestamp:new Date(A.created_at*1e3),modelId:A.model,headers:z,body:ae},providerMetadata:me,warnings:W}}async doStream(t){const{args:r,warnings:m,webSearchToolName:p,toolNameMapping:d,store:u,providerOptionsName:i}=await this.getArgs(t),{responseHeaders:c,value:f}=await de({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),body:{...r,stream:!0},failedResponseHandler:le,successfulResponseHandler:Ie(To),abortSignal:t.abortSignal,fetch:this.config.fetch}),y=this,q=Be(t.prompt),R=new Map;let I={unified:"other",raw:void 0},x;const S=[];let O=null;const h={},U=[];let E=!1;const C={};let J;return{stream:f.pipeThrough(new TransformStream({start(V){V.enqueue({type:"stream-start",warnings:m})},transform(V,n){var M,B,N,K,W,b,_,T,P,g,z,A,ae,$,X,te,me,ge,k,G,re,L,Te,qe,Se,Ne,Re,Me,Pe,Oe;if(t.includeRawChunks&&n.enqueue({type:"raw",rawValue:V.rawValue}),!V.success){I={unified:"error",raw:void 0},n.enqueue({type:"error",error:V.error});return}const a=V.value;if(Ge(a)){if(a.item.type==="function_call")h[a.output_index]={toolName:a.item.name,toolCallId:a.item.call_id},n.enqueue({type:"tool-input-start",id:a.item.call_id,toolName:a.item.name});else if(a.item.type==="web_search_call")h[a.output_index]={toolName:d.toCustomToolName(p??"web_search"),toolCallId:a.item.id},n.enqueue({type:"tool-input-start",id:a.item.id,toolName:d.toCustomToolName(p??"web_search"),providerExecuted:!0}),n.enqueue({type:"tool-input-end",id:a.item.id}),n.enqueue({type:"tool-call",toolCallId:a.item.id,toolName:d.toCustomToolName(p??"web_search"),input:JSON.stringify({}),providerExecuted:!0});else if(a.item.type==="computer_call")h[a.output_index]={toolName:d.toCustomToolName("computer_use"),toolCallId:a.item.id},n.enqueue({type:"tool-input-start",id:a.item.id,toolName:d.toCustomToolName("computer_use"),providerExecuted:!0});else if(a.item.type==="code_interpreter_call")h[a.output_index]={toolName:d.toCustomToolName("code_interpreter"),toolCallId:a.item.id,codeInterpreter:{containerId:a.item.container_id}},n.enqueue({type:"tool-input-start",id:a.item.id,toolName:d.toCustomToolName("code_interpreter"),providerExecuted:!0}),n.enqueue({type:"tool-input-delta",id:a.item.id,delta:`{"containerId":"${a.item.container_id}","code":"`});else if(a.item.type==="file_search_call")n.enqueue({type:"tool-call",toolCallId:a.item.id,toolName:d.toCustomToolName("file_search"),input:"{}",providerExecuted:!0});else if(a.item.type==="image_generation_call")n.enqueue({type:"tool-call",toolCallId:a.item.id,toolName:d.toCustomToolName("image_generation"),input:"{}",providerExecuted:!0});else if(!(a.item.type==="mcp_call"||a.item.type==="mcp_list_tools"||a.item.type==="mcp_approval_request"))if(a.item.type==="apply_patch_call"){const{call_id:w,operation:Y}=a.item;if(h[a.output_index]={toolName:d.toCustomToolName("apply_patch"),toolCallId:w,applyPatch:{hasDiff:Y.type==="delete_file",endEmitted:Y.type==="delete_file"}},n.enqueue({type:"tool-input-start",id:w,toolName:d.toCustomToolName("apply_patch")}),Y.type==="delete_file"){const ie=JSON.stringify({callId:w,operation:Y});n.enqueue({type:"tool-input-delta",id:w,delta:ie}),n.enqueue({type:"tool-input-end",id:w})}else n.enqueue({type:"tool-input-delta",id:w,delta:`{"callId":"${he(w)}","operation":{"type":"${he(Y.type)}","path":"${he(Y.path)}","diff":"`})}else a.item.type==="shell_call"?h[a.output_index]={toolName:d.toCustomToolName("shell"),toolCallId:a.item.call_id}:a.item.type==="message"?(U.splice(0,U.length),n.enqueue({type:"text-start",id:a.item.id,providerMetadata:{[i]:{itemId:a.item.id}}})):Ge(a)&&a.item.type==="reasoning"&&(C[a.item.id]={encryptedContent:a.item.encrypted_content,summaryParts:{0:"active"}},n.enqueue({type:"reasoning-start",id:`${a.item.id}:0`,providerMetadata:{[i]:{itemId:a.item.id,reasoningEncryptedContent:(M=a.item.encrypted_content)!=null?M:null}}}))}else if(Mo(a)){if(a.item.type==="message")n.enqueue({type:"text-end",id:a.item.id,providerMetadata:{[i]:{itemId:a.item.id,...U.length>0&&{annotations:U}}}});else if(a.item.type==="function_call")h[a.output_index]=void 0,E=!0,n.enqueue({type:"tool-input-end",id:a.item.call_id}),n.enqueue({type:"tool-call",toolCallId:a.item.call_id,toolName:a.item.name,input:a.item.arguments,providerMetadata:{[i]:{itemId:a.item.id}}});else if(a.item.type==="web_search_call")h[a.output_index]=void 0,n.enqueue({type:"tool-result",toolCallId:a.item.id,toolName:d.toCustomToolName(p??"web_search"),result:Ke(a.item.action)});else if(a.item.type==="computer_call")h[a.output_index]=void 0,n.enqueue({type:"tool-input-end",id:a.item.id}),n.enqueue({type:"tool-call",toolCallId:a.item.id,toolName:d.toCustomToolName("computer_use"),input:"",providerExecuted:!0}),n.enqueue({type:"tool-result",toolCallId:a.item.id,toolName:d.toCustomToolName("computer_use"),result:{type:"computer_use_tool_result",status:a.item.status||"completed"}});else if(a.item.type==="file_search_call")h[a.output_index]=void 0,n.enqueue({type:"tool-result",toolCallId:a.item.id,toolName:d.toCustomToolName("file_search"),result:{queries:a.item.queries,results:(N=(B=a.item.results)==null?void 0:B.map(w=>({attributes:w.attributes,fileId:w.file_id,filename:w.filename,score:w.score,text:w.text})))!=null?N:null}});else if(a.item.type==="code_interpreter_call")h[a.output_index]=void 0,n.enqueue({type:"tool-result",toolCallId:a.item.id,toolName:d.toCustomToolName("code_interpreter"),result:{outputs:a.item.outputs}});else if(a.item.type==="image_generation_call")n.enqueue({type:"tool-result",toolCallId:a.item.id,toolName:d.toCustomToolName("image_generation"),result:{result:a.item.result}});else if(a.item.type==="mcp_call"){h[a.output_index]=void 0;const w=(K=a.item.approval_request_id)!=null?K:void 0,Y=w!=null&&(b=(W=R.get(w))!=null?W:q[w])!=null?b:a.item.id,ie=`mcp.${a.item.name}`;n.enqueue({type:"tool-call",toolCallId:Y,toolName:ie,input:a.item.arguments,providerExecuted:!0,dynamic:!0}),n.enqueue({type:"tool-result",toolCallId:Y,toolName:ie,result:{type:"call",serverLabel:a.item.server_label,name:a.item.name,arguments:a.item.arguments,...a.item.output!=null?{output:a.item.output}:{},...a.item.error!=null?{error:a.item.error}:{}},providerMetadata:{[i]:{itemId:a.item.id}}})}else if(a.item.type==="mcp_list_tools")h[a.output_index]=void 0;else if(a.item.type==="apply_patch_call"){const w=h[a.output_index];w?.applyPatch&&!w.applyPatch.endEmitted&&a.item.operation.type!=="delete_file"&&(w.applyPatch.hasDiff||n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:he(a.item.operation.diff)}),n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:'"}}'}),n.enqueue({type:"tool-input-end",id:w.toolCallId}),w.applyPatch.endEmitted=!0),w&&a.item.status==="completed"&&n.enqueue({type:"tool-call",toolCallId:w.toolCallId,toolName:d.toCustomToolName("apply_patch"),input:JSON.stringify({callId:a.item.call_id,operation:a.item.operation}),providerMetadata:{[i]:{itemId:a.item.id}}}),h[a.output_index]=void 0}else if(a.item.type==="mcp_approval_request"){h[a.output_index]=void 0;const w=(P=(T=(_=y.config).generateId)==null?void 0:T.call(_))!=null?P:oe(),Y=(g=a.item.approval_request_id)!=null?g:a.item.id;R.set(Y,w);const ie=`mcp.${a.item.name}`;n.enqueue({type:"tool-call",toolCallId:w,toolName:ie,input:a.item.arguments,providerExecuted:!0,dynamic:!0}),n.enqueue({type:"tool-approval-request",approvalId:Y,toolCallId:w})}else if(a.item.type==="local_shell_call")h[a.output_index]=void 0,n.enqueue({type:"tool-call",toolCallId:a.item.call_id,toolName:d.toCustomToolName("local_shell"),input:JSON.stringify({action:{type:"exec",command:a.item.action.command,timeoutMs:a.item.action.timeout_ms,user:a.item.action.user,workingDirectory:a.item.action.working_directory,env:a.item.action.env}}),providerMetadata:{[i]:{itemId:a.item.id}}});else if(a.item.type==="shell_call")h[a.output_index]=void 0,n.enqueue({type:"tool-call",toolCallId:a.item.call_id,toolName:d.toCustomToolName("shell"),input:JSON.stringify({action:{commands:a.item.action.commands}}),providerMetadata:{[i]:{itemId:a.item.id}}});else if(a.item.type==="reasoning"){const w=C[a.item.id],Y=Object.entries(w.summaryParts).filter(([ie,Ae])=>Ae==="active"||Ae==="can-conclude").map(([ie])=>ie);for(const ie of Y)n.enqueue({type:"reasoning-end",id:`${a.item.id}:${ie}`,providerMetadata:{[i]:{itemId:a.item.id,reasoningEncryptedContent:(z=a.item.encrypted_content)!=null?z:null}}});delete C[a.item.id]}}else if(Ao(a)){const w=h[a.output_index];w!=null&&n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:a.delta})}else if(Do(a)){const w=h[a.output_index];w?.applyPatch&&(n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:he(a.delta)}),w.applyPatch.hasDiff=!0)}else if(Wo(a)){const w=h[a.output_index];w?.applyPatch&&!w.applyPatch.endEmitted&&(w.applyPatch.hasDiff||(n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:he(a.diff)}),w.applyPatch.hasDiff=!0),n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:'"}}'}),n.enqueue({type:"tool-input-end",id:w.toolCallId}),w.applyPatch.endEmitted=!0)}else if($o(a))n.enqueue({type:"tool-result",toolCallId:a.item_id,toolName:d.toCustomToolName("image_generation"),result:{result:a.partial_image_b64},preliminary:!0});else if(Eo(a)){const w=h[a.output_index];w!=null&&n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:he(a.delta)})}else if(jo(a)){const w=h[a.output_index];w!=null&&(n.enqueue({type:"tool-input-delta",id:w.toolCallId,delta:'"}'}),n.enqueue({type:"tool-input-end",id:w.toolCallId}),n.enqueue({type:"tool-call",toolCallId:w.toolCallId,toolName:d.toCustomToolName("code_interpreter"),input:JSON.stringify({code:a.code,containerId:w.codeInterpreter.containerId}),providerExecuted:!0}))}else if(Oo(a))O=a.response.id,n.enqueue({type:"response-metadata",id:a.response.id,timestamp:new Date(a.response.created_at*1e3),modelId:a.response.model});else if(Ro(a))n.enqueue({type:"text-delta",id:a.item_id,delta:a.delta}),(ae=(A=t.providerOptions)==null?void 0:A[i])!=null&&ae.logprobs&&a.logprobs&&S.push(a.logprobs);else if(a.type==="response.reasoning_summary_part.added"){if(a.summary_index>0){const w=C[a.item_id];w.summaryParts[a.summary_index]="active";for(const Y of Object.keys(w.summaryParts))w.summaryParts[Y]==="can-conclude"&&(n.enqueue({type:"reasoning-end",id:`${a.item_id}:${Y}`,providerMetadata:{[i]:{itemId:a.item_id}}}),w.summaryParts[Y]="concluded");n.enqueue({type:"reasoning-start",id:`${a.item_id}:${a.summary_index}`,providerMetadata:{[i]:{itemId:a.item_id,reasoningEncryptedContent:(X=($=C[a.item_id])==null?void 0:$.encryptedContent)!=null?X:null}}})}}else a.type==="response.reasoning_summary_text.delta"?n.enqueue({type:"reasoning-delta",id:`${a.item_id}:${a.summary_index}`,delta:a.delta,providerMetadata:{[i]:{itemId:a.item_id}}}):a.type==="response.reasoning_summary_part.done"?u?(n.enqueue({type:"reasoning-end",id:`${a.item_id}:${a.summary_index}`,providerMetadata:{[i]:{itemId:a.item_id}}}),C[a.item_id].summaryParts[a.summary_index]="concluded"):C[a.item_id].summaryParts[a.summary_index]="can-conclude":Po(a)?(I={unified:Le({finishReason:(te=a.response.incomplete_details)==null?void 0:te.reason,hasFunctionCall:E}),raw:(ge=(me=a.response.incomplete_details)==null?void 0:me.reason)!=null?ge:void 0},x=a.response.usage,typeof a.response.service_tier=="string"&&(J=a.response.service_tier)):Ho(a)?(U.push(a.annotation),a.annotation.type==="url_citation"?n.enqueue({type:"source",sourceType:"url",id:(re=(G=(k=y.config).generateId)==null?void 0:G.call(k))!=null?re:oe(),url:a.annotation.url,title:a.annotation.title}):a.annotation.type==="file_citation"?n.enqueue({type:"source",sourceType:"document",id:(qe=(Te=(L=y.config).generateId)==null?void 0:Te.call(L))!=null?qe:oe(),mediaType:"text/plain",title:a.annotation.filename,filename:a.annotation.filename,providerMetadata:{[i]:{type:a.annotation.type,fileId:a.annotation.file_id,index:a.annotation.index}}}):a.annotation.type==="container_file_citation"?n.enqueue({type:"source",sourceType:"document",id:(Re=(Ne=(Se=y.config).generateId)==null?void 0:Ne.call(Se))!=null?Re:oe(),mediaType:"text/plain",title:a.annotation.filename,filename:a.annotation.filename,providerMetadata:{[i]:{type:a.annotation.type,fileId:a.annotation.file_id,containerId:a.annotation.container_id}}}):a.annotation.type==="file_path"&&n.enqueue({type:"source",sourceType:"document",id:(Oe=(Pe=(Me=y.config).generateId)==null?void 0:Pe.call(Me))!=null?Oe:oe(),mediaType:"application/octet-stream",title:a.annotation.file_id,filename:a.annotation.file_id,providerMetadata:{[i]:{type:a.annotation.type,fileId:a.annotation.file_id,index:a.annotation.index}}})):Uo(a)&&n.enqueue({type:"error",error:a})},flush(V){const n={[i]:{responseId:O,...S.length>0?{logprobs:S}:{},...J!==void 0?{serviceTier:J}:{}}};V.enqueue({type:"finish",finishReason:I,usage:ze(x),providerMetadata:n})}})),request:{body:r},response:{headers:c}}}};function Ro(t){return t.type==="response.output_text.delta"}function Mo(t){return t.type==="response.output_item.done"}function Po(t){return t.type==="response.completed"||t.type==="response.incomplete"}function Oo(t){return t.type==="response.created"}function Ao(t){return t.type==="response.function_call_arguments.delta"}function $o(t){return t.type==="response.image_generation_call.partial_image"}function Eo(t){return t.type==="response.code_interpreter_call_code.delta"}function jo(t){return t.type==="response.code_interpreter_call_code.done"}function Do(t){return t.type==="response.apply_patch_call_operation_diff.delta"}function Wo(t){return t.type==="response.apply_patch_call_operation_diff.done"}function Ge(t){return t.type==="response.output_item.added"}function Ho(t){return t.type==="response.output_text.annotation.added"}function Uo(t){return t.type==="error"}function Ke(t){var r;switch(t.type){case"search":return{action:{type:"search",query:(r=t.query)!=null?r:void 0},...t.sources!=null&&{sources:t.sources}};case"open_page":return{action:{type:"openPage",url:t.url}};case"find_in_page":return{action:{type:"findInPage",url:t.url,pattern:t.pattern}}}}function he(t){return JSON.stringify(t).slice(1,-1)}var Vo=j(()=>D(o({instructions:e().nullish(),speed:s().min(.25).max(4).default(1).nullish()}))),zo=class{constructor(t,r){this.modelId=t,this.config=r,this.specificationVersion="v3"}get provider(){return this.config.provider}async getArgs({text:t,voice:r="alloy",outputFormat:m="mp3",speed:p,instructions:d,language:u,providerOptions:i}){const c=[],f=await ue({provider:"openai",providerOptions:i,schema:Vo}),y={model:this.modelId,input:t,voice:r,response_format:"mp3",speed:p,instructions:d};if(m&&(["mp3","opus","aac","flac","wav","pcm"].includes(m)?y.response_format=m:c.push({type:"unsupported",feature:"outputFormat",details:`Unsupported output format: ${m}. Using mp3 instead.`})),f){const q={};for(const R in q){const I=q[R];I!==void 0&&(y[R]=I)}}return u&&c.push({type:"unsupported",feature:"language",details:`OpenAI speech models do not support language selection. Language parameter "${u}" was ignored.`}),{requestBody:y,warnings:c}}async doGenerate(t){var r,m,p;const d=(p=(m=(r=this.config._internal)==null?void 0:r.currentDate)==null?void 0:m.call(r))!=null?p:new Date,{requestBody:u,warnings:i}=await this.getArgs(t),{value:c,responseHeaders:f,rawValue:y}=await de({url:this.config.url({path:"/audio/speech",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),body:u,failedResponseHandler:le,successfulResponseHandler:bt(),abortSignal:t.abortSignal,fetch:this.config.fetch});return{audio:c,warnings:i,request:{body:JSON.stringify(u)},response:{timestamp:d,modelId:this.modelId,headers:f,body:y}}}},Jo=j(()=>D(o({text:e(),language:e().nullish(),duration:s().nullish(),words:v(o({word:e(),start:s(),end:s()})).nullish(),segments:v(o({id:s(),seek:s(),start:s(),end:s(),text:e(),tokens:v(s()),temperature:s(),avg_logprob:s(),compression_ratio:s(),no_speech_prob:s()})).nullish()}))),Lo=j(()=>D(o({include:v(e()).optional(),language:e().optional(),prompt:e().optional(),temperature:s().min(0).max(1).default(0).optional(),timestampGranularities:v(H(["word","segment"])).default(["segment"]).optional()}))),Ze={afrikaans:"af",arabic:"ar",armenian:"hy",azerbaijani:"az",belarusian:"be",bosnian:"bs",bulgarian:"bg",catalan:"ca",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",finnish:"fi",french:"fr",galician:"gl",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",icelandic:"is",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",macedonian:"mk",malay:"ms",marathi:"mr",maori:"mi",nepali:"ne",norwegian:"no",persian:"fa",polish:"pl",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"sr",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",vietnamese:"vi",welsh:"cy"},Fo=class{constructor(t,r){this.modelId=t,this.config=r,this.specificationVersion="v3"}get provider(){return this.config.provider}async getArgs({audio:t,mediaType:r,providerOptions:m}){const p=[],d=await ue({provider:"openai",providerOptions:m,schema:Lo}),u=new FormData,i=t instanceof Uint8Array?new Blob([t]):new Blob([xe(t)]);u.append("model",this.modelId);const c=ht(r);if(u.append("file",new File([i],"audio",{type:r}),`audio.${c}`),d){const f={include:d.include,language:d.language,prompt:d.prompt,response_format:["gpt-4o-transcribe","gpt-4o-mini-transcribe"].includes(this.modelId)?"json":"verbose_json",temperature:d.temperature,timestamp_granularities:d.timestampGranularities};for(const[y,q]of Object.entries(f))if(q!=null)if(Array.isArray(q))for(const R of q)u.append(`${y}[]`,String(R));else u.append(y,String(q))}return{formData:u,warnings:p}}async doGenerate(t){var r,m,p,d,u,i,c,f;const y=(p=(m=(r=this.config._internal)==null?void 0:r.currentDate)==null?void 0:m.call(r))!=null?p:new Date,{formData:q,warnings:R}=await this.getArgs(t),{value:I,responseHeaders:x,rawValue:S}=await Xe({url:this.config.url({path:"/audio/transcriptions",modelId:this.modelId}),headers:se(this.config.headers(),t.headers),formData:q,failedResponseHandler:le,successfulResponseHandler:_e(Jo),abortSignal:t.abortSignal,fetch:this.config.fetch}),O=I.language!=null&&I.language in Ze?Ze[I.language]:void 0;return{text:I.text,segments:(c=(i=(d=I.segments)==null?void 0:d.map(h=>({text:h.text,startSecond:h.start,endSecond:h.end})))!=null?i:(u=I.words)==null?void 0:u.map(h=>({text:h.word,startSecond:h.start,endSecond:h.end})))!=null?c:[],language:O,durationInSeconds:(f=I.duration)!=null?f:void 0,warnings:R,response:{timestamp:y,modelId:this.modelId,headers:x,body:S}}}},Bo="3.0.26";function Go(t={}){var r,m;const p=(r=ut(dt({settingValue:t.baseURL,environmentVariableName:"OPENAI_BASE_URL"})))!=null?r:"https://api.openai.com/v1",d=(m=t.name)!=null?m:"openai",u=()=>_t({Authorization:`Bearer ${ft({apiKey:t.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":t.organization,"OpenAI-Project":t.project,...t.headers},`ai-sdk/openai/${Bo}`),i=O=>new Pt(O,{provider:`${d}.chat`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch}),c=O=>new Et(O,{provider:`${d}.completion`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch}),f=O=>new Wt(O,{provider:`${d}.embedding`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch}),y=O=>new zt(O,{provider:`${d}.image`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch}),q=O=>new Fo(O,{provider:`${d}.transcription`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch}),R=O=>new zo(O,{provider:`${d}.speech`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch}),I=O=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return x(O)},x=O=>new No(O,{provider:`${d}.responses`,url:({path:h})=>`${p}${h}`,headers:u,fetch:t.fetch,fileIdPrefixes:["file-"]}),S=function(O){return I(O)};return S.specificationVersion="v3",S.languageModel=I,S.chat=i,S.completion=c,S.responses=x,S.embedding=f,S.embeddingModel=f,S.textEmbedding=f,S.textEmbeddingModel=f,S.image=y,S.imageModel=y,S.transcription=q,S.transcriptionModel=q,S.speech=R,S.speechModel=R,S.tools=Io,S}Go();export{Bo as VERSION,Go as createOpenAI};
