import{b as Y,d as Re,g as oe,p as B,c as q,r as U,a as W,f as z,k as Oe,n as G,U as ne,m as ie,o as ve,z as V,q as ae,T as xe,h as ye,A as F,i as we,e as _e,w as re,H as Me,J as Z,K as Ne}from"./p6dsmFtl.js";import{o as l,n as I,s,_ as O,r as Ae,b as L,a as b,u as Ee,c as De}from"./pRZOK57-.js";function se(e){var a,c,u,n;if(e==null)return{inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0},raw:void 0};const y=(a=e.promptTokenCount)!=null?a:0,f=(c=e.candidatesTokenCount)!=null?c:0,_=(u=e.cachedContentTokenCount)!=null?u:0,d=(n=e.thoughtsTokenCount)!=null?n:0;return{inputTokens:{total:y,noCache:y-_,cacheRead:_,cacheWrite:void 0},outputTokens:{total:f+d,text:f,reasoning:d},raw:e}}function k(e,a=!0){if(e==null)return;if(ke(e))return a?void 0:typeof e=="object"&&e.description?{type:"object",description:e.description}:{type:"object"};if(typeof e=="boolean")return{type:"boolean",properties:{}};const{type:c,description:u,required:n,properties:y,items:f,allOf:_,anyOf:d,oneOf:p,format:v,const:m,minLength:o,enum:t}=e,g={};if(u&&(g.description=u),n&&(g.required=n),v&&(g.format=v),m!==void 0&&(g.enum=[m]),c)if(Array.isArray(c)){const r=c.includes("null"),h=c.filter(S=>S!=="null");h.length===0?g.type="null":(g.anyOf=h.map(S=>({type:S})),r&&(g.nullable=!0))}else g.type=c;if(t!==void 0&&(g.enum=t),y!=null&&(g.properties=Object.entries(y).reduce((r,[h,S])=>(r[h]=k(S,!1),r),{})),f&&(g.items=Array.isArray(f)?f.map(r=>k(r,!1)):k(f,!1)),_&&(g.allOf=_.map(r=>k(r,!1))),d)if(d.some(r=>typeof r=="object"&&r?.type==="null")){const r=d.filter(h=>!(typeof h=="object"&&h?.type==="null"));if(r.length===1){const h=k(r[0],!1);typeof h=="object"&&(g.nullable=!0,Object.assign(g,h))}else g.anyOf=r.map(h=>k(h,!1)),g.nullable=!0}else g.anyOf=d.map(r=>k(r,!1));return p&&(g.oneOf=p.map(r=>k(r,!1))),o!==void 0&&(g.minLength=o),g}function ke(e){return e!=null&&typeof e=="object"&&e.type==="object"&&(e.properties==null||Object.keys(e.properties).length===0)&&!e.additionalProperties}function Ge(e,a){var c,u,n;const y=[],f=[];let _=!0;const d=(c=a?.isGemmaModel)!=null?c:!1,p=(u=a?.providerOptionsName)!=null?u:"google";for(const{role:v,content:m}of e)switch(v){case"system":{if(!_)throw new ne({functionality:"system messages are only supported at the beginning of the conversation"});y.push({text:m});break}case"user":{_=!1;const o=[];for(const t of m)switch(t.type){case"text":{o.push({text:t.text});break}case"file":{const g=t.mediaType==="image/*"?"image/jpeg":t.mediaType;o.push(t.data instanceof URL?{fileData:{mimeType:g,fileUri:t.data.toString()}}:{inlineData:{mimeType:g,data:ie(t.data)}});break}}f.push({role:"user",parts:o});break}case"assistant":{_=!1,f.push({role:"model",parts:m.map(o=>{var t;const g=(t=o.providerOptions)==null?void 0:t[p],r=g?.thoughtSignature!=null?String(g.thoughtSignature):void 0;switch(o.type){case"text":return o.text.length===0?void 0:{text:o.text,thoughtSignature:r};case"reasoning":return o.text.length===0?void 0:{text:o.text,thought:!0,thoughtSignature:r};case"file":{if(o.data instanceof URL)throw new ne({functionality:"File data URLs in assistant messages are not supported"});return{inlineData:{mimeType:o.mediaType,data:ie(o.data)},thoughtSignature:r}}case"tool-call":return{functionCall:{name:o.toolName,args:o.input},thoughtSignature:r}}}).filter(o=>o!==void 0)});break}case"tool":{_=!1;const o=[];for(const t of m){if(t.type==="tool-approval-response")continue;const g=t.output;if(g.type==="content")for(const r of g.value)switch(r.type){case"text":o.push({functionResponse:{name:t.toolName,response:{name:t.toolName,content:r.text}}});break;case"image-data":o.push({inlineData:{mimeType:r.mediaType,data:r.data}},{text:"Tool executed successfully and returned this image as a response"});break;default:o.push({text:JSON.stringify(r)});break}else o.push({functionResponse:{name:t.toolName,response:{name:t.toolName,content:g.type==="execution-denied"?(n=g.reason)!=null?n:"Tool execution denied.":g.value}}})}f.push({role:"user",parts:o});break}}if(d&&y.length>0&&f.length>0&&f[0].role==="user"){const v=y.map(m=>m.text).join(`

`);f[0].parts.unshift({text:v+`

`})}return{systemInstruction:y.length>0&&!d?{parts:y}:void 0,contents:f}}function le(e){return e.includes("/")?e:`models/${e}`}var Ve=G(()=>V(l({error:l({code:I().nullable(),message:s(),status:s()})}))),ue=ve({errorSchema:Ve,errorToMessage:e=>e.error.message}),de=G(()=>V(l({responseModalities:b(O(["TEXT","IMAGE"])).optional(),thinkingConfig:l({thinkingBudget:I().optional(),includeThoughts:L().optional(),thinkingLevel:O(["minimal","low","medium","high"]).optional()}).optional(),cachedContent:s().optional(),structuredOutputs:L().optional(),safetySettings:b(l({category:O(["HARM_CATEGORY_UNSPECIFIED","HARM_CATEGORY_HATE_SPEECH","HARM_CATEGORY_DANGEROUS_CONTENT","HARM_CATEGORY_HARASSMENT","HARM_CATEGORY_SEXUALLY_EXPLICIT","HARM_CATEGORY_CIVIC_INTEGRITY"]),threshold:O(["HARM_BLOCK_THRESHOLD_UNSPECIFIED","BLOCK_LOW_AND_ABOVE","BLOCK_MEDIUM_AND_ABOVE","BLOCK_ONLY_HIGH","BLOCK_NONE","OFF"])})).optional(),threshold:O(["HARM_BLOCK_THRESHOLD_UNSPECIFIED","BLOCK_LOW_AND_ABOVE","BLOCK_MEDIUM_AND_ABOVE","BLOCK_ONLY_HIGH","BLOCK_NONE","OFF"]).optional(),audioTimestamp:L().optional(),labels:Ae(s(),s()).optional(),mediaResolution:O(["MEDIA_RESOLUTION_UNSPECIFIED","MEDIA_RESOLUTION_LOW","MEDIA_RESOLUTION_MEDIUM","MEDIA_RESOLUTION_HIGH"]).optional(),imageConfig:l({aspectRatio:O(["1:1","2:3","3:2","3:4","4:3","4:5","5:4","9:16","16:9","21:9"]).optional(),imageSize:O(["1K","2K","4K"]).optional()}).optional(),retrievalConfig:l({latLng:l({latitude:I(),longitude:I()}).optional()}).optional()})));function Le({tools:e,toolChoice:a,modelId:c}){var u;e=e?.length?e:void 0;const n=[],y=["gemini-flash-latest","gemini-flash-lite-latest","gemini-pro-latest"].some(t=>t===c),f=c.includes("gemini-2")||c.includes("gemini-3")||y,_=c.includes("gemini-1.5-flash")&&!c.includes("-8b"),d=c.includes("gemini-2.5")||c.includes("gemini-3");if(e==null)return{tools:void 0,toolConfig:void 0,toolWarnings:n};const p=e.some(t=>t.type==="function"),v=e.some(t=>t.type==="provider");if(p&&v&&n.push({type:"unsupported",feature:"combination of function and provider-defined tools"}),v){const t=[];return e.filter(r=>r.type==="provider").forEach(r=>{switch(r.id){case"google.google_search":f?t.push({googleSearch:{}}):_?t.push({googleSearchRetrieval:{dynamicRetrievalConfig:{mode:r.args.mode,dynamicThreshold:r.args.dynamicThreshold}}}):t.push({googleSearchRetrieval:{}});break;case"google.enterprise_web_search":f?t.push({enterpriseWebSearch:{}}):n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`,details:"Enterprise Web Search requires Gemini 2.0 or newer."});break;case"google.url_context":f?t.push({urlContext:{}}):n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`,details:"The URL context tool is not supported with other Gemini models than Gemini 2."});break;case"google.code_execution":f?t.push({codeExecution:{}}):n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`,details:"The code execution tools is not supported with other Gemini models than Gemini 2."});break;case"google.file_search":d?t.push({fileSearch:{...r.args}}):n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`,details:"The file search tool is only supported with Gemini 2.5 models and Gemini 3 models."});break;case"google.vertex_rag_store":f?t.push({retrieval:{vertex_rag_store:{rag_resources:{rag_corpus:r.args.ragCorpus},similarity_top_k:r.args.topK}}}):n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`,details:"The RAG store tool is not supported with other Gemini models than Gemini 2."});break;case"google.google_maps":f?t.push({googleMaps:{}}):n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`,details:"The Google Maps grounding tool is not supported with Gemini models other than Gemini 2 or newer."});break;default:n.push({type:"unsupported",feature:`provider-defined tool ${r.id}`});break}}),{tools:t.length>0?t:void 0,toolConfig:void 0,toolWarnings:n}}const m=[];for(const t of e)t.type==="function"?m.push({name:t.name,description:(u=t.description)!=null?u:"",parameters:k(t.inputSchema)}):n.push({type:"unsupported",feature:`function tool ${t.name}`});if(a==null)return{tools:[{functionDeclarations:m}],toolConfig:void 0,toolWarnings:n};const o=a.type;switch(o){case"auto":return{tools:[{functionDeclarations:m}],toolConfig:{functionCallingConfig:{mode:"AUTO"}},toolWarnings:n};case"none":return{tools:[{functionDeclarations:m}],toolConfig:{functionCallingConfig:{mode:"NONE"}},toolWarnings:n};case"required":return{tools:[{functionDeclarations:m}],toolConfig:{functionCallingConfig:{mode:"ANY"}},toolWarnings:n};case"tool":return{tools:[{functionDeclarations:m}],toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[a.toolName]}},toolWarnings:n};default:{const t=o;throw new ne({functionality:`tool choice type: ${t}`})}}}function ce({finishReason:e,hasToolCalls:a}){switch(e){case"STOP":return a?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"IMAGE_SAFETY":case"RECITATION":case"SAFETY":case"BLOCKLIST":case"PROHIBITED_CONTENT":case"SPII":return"content-filter";case"MALFORMED_FUNCTION_CALL":return"error";default:return"other"}}var Ue=class{constructor(e,a){this.specificationVersion="v3";var c;this.modelId=e,this.config=a,this.generateId=(c=a.generateId)!=null?c:oe}get provider(){return this.config.provider}get supportedUrls(){var e,a,c;return(c=(a=(e=this.config).supportedUrls)==null?void 0:a.call(e))!=null?c:{}}async getArgs({prompt:e,maxOutputTokens:a,temperature:c,topP:u,topK:n,frequencyPenalty:y,presencePenalty:f,stopSequences:_,responseFormat:d,seed:p,tools:v,toolChoice:m,providerOptions:o}){var t;const g=[],r=this.config.provider.includes("vertex")?"vertex":"google";let h=await B({provider:r,providerOptions:o,schema:de});h==null&&r!=="google"&&(h=await B({provider:"google",providerOptions:o,schema:de})),v?.some(i=>i.type==="provider"&&i.id==="google.vertex_rag_store")&&!this.config.provider.startsWith("google.vertex.")&&g.push({type:"other",message:`The 'vertex_rag_store' tool is only supported with the Google Vertex provider and might not be supported or could behave unexpectedly with the current Google provider (${this.config.provider}).`});const S=this.modelId.toLowerCase().startsWith("gemma-"),{contents:E,systemInstruction:N}=Ge(e,{isGemmaModel:S,providerOptionsName:r}),{tools:R,toolConfig:C,toolWarnings:w}=Le({tools:v,toolChoice:m,modelId:this.modelId});return{args:{generationConfig:{maxOutputTokens:a,temperature:c,topK:n,topP:u,frequencyPenalty:y,presencePenalty:f,stopSequences:_,seed:p,responseMimeType:d?.type==="json"?"application/json":void 0,responseSchema:d?.type==="json"&&d.schema!=null&&((t=h?.structuredOutputs)==null||t)?k(d.schema):void 0,...h?.audioTimestamp&&{audioTimestamp:h.audioTimestamp},responseModalities:h?.responseModalities,thinkingConfig:h?.thinkingConfig,...h?.mediaResolution&&{mediaResolution:h.mediaResolution},...h?.imageConfig&&{imageConfig:h.imageConfig}},contents:E,systemInstruction:S?void 0:N,safetySettings:h?.safetySettings,tools:R,toolConfig:h?.retrievalConfig?{...C,retrievalConfig:h.retrievalConfig}:C,cachedContent:h?.cachedContent,labels:h?.labels},warnings:[...g,...w],providerOptionsName:r}}async doGenerate(e){var a,c,u,n,y,f,_,d,p;const{args:v,warnings:m,providerOptionsName:o}=await this.getArgs(e),t=q(await U(this.config.headers),e.headers),{responseHeaders:g,value:r,rawValue:h}=await W({url:`${this.config.baseURL}/${le(this.modelId)}:generateContent`,headers:t,body:v,failedResponseHandler:ue,successfulResponseHandler:z(He),abortSignal:e.abortSignal,fetch:this.config.fetch}),S=r.candidates[0],E=[],N=(c=(a=S.content)==null?void 0:a.parts)!=null?c:[],R=r.usageMetadata;let C;for(const i of N)if("executableCode"in i&&((u=i.executableCode)!=null&&u.code)){const M=this.config.generateId();C=M,E.push({type:"tool-call",toolCallId:M,toolName:"code_execution",input:JSON.stringify(i.executableCode),providerExecuted:!0})}else"codeExecutionResult"in i&&i.codeExecutionResult?(E.push({type:"tool-result",toolCallId:C,toolName:"code_execution",result:{outcome:i.codeExecutionResult.outcome,output:i.codeExecutionResult.output}}),C=void 0):"text"in i&&i.text!=null&&i.text.length>0?E.push({type:i.thought===!0?"reasoning":"text",text:i.text,providerMetadata:i.thoughtSignature?{[o]:{thoughtSignature:i.thoughtSignature}}:void 0}):"functionCall"in i?E.push({type:"tool-call",toolCallId:this.config.generateId(),toolName:i.functionCall.name,input:JSON.stringify(i.functionCall.args),providerMetadata:i.thoughtSignature?{[o]:{thoughtSignature:i.thoughtSignature}}:void 0}):"inlineData"in i&&E.push({type:"file",data:i.inlineData.data,mediaType:i.inlineData.mimeType,providerMetadata:i.thoughtSignature?{[o]:{thoughtSignature:i.thoughtSignature}}:void 0});const w=(n=pe({groundingMetadata:S.groundingMetadata,generateId:this.config.generateId}))!=null?n:[];for(const i of w)E.push(i);return{content:E,finishReason:{unified:ce({finishReason:S.finishReason,hasToolCalls:E.some(i=>i.type==="tool-call"&&!i.providerExecuted)}),raw:(y=S.finishReason)!=null?y:void 0},usage:se(R),warnings:m,providerMetadata:{[o]:{promptFeedback:(f=r.promptFeedback)!=null?f:null,groundingMetadata:(_=S.groundingMetadata)!=null?_:null,urlContextMetadata:(d=S.urlContextMetadata)!=null?d:null,safetyRatings:(p=S.safetyRatings)!=null?p:null,usageMetadata:R??null}},request:{body:v},response:{headers:g,body:h}}}async doStream(e){const{args:a,warnings:c,providerOptionsName:u}=await this.getArgs(e),n=q(await U(this.config.headers),e.headers),{responseHeaders:y,value:f}=await W({url:`${this.config.baseURL}/${le(this.modelId)}:streamGenerateContent?alt=sse`,headers:n,body:a,failedResponseHandler:ue,successfulResponseHandler:Oe(Ke),abortSignal:e.abortSignal,fetch:this.config.fetch});let _={unified:"other",raw:void 0},d,p;const v=this.config.generateId;let m=!1,o=null,t=null,g=0;const r=new Set;let h;return{stream:f.pipeThrough(new TransformStream({start(S){S.enqueue({type:"stream-start",warnings:c})},transform(S,E){var N,R,C,w,i,M,K;if(e.includeRawChunks&&E.enqueue({type:"raw",rawValue:S.rawValue}),!S.success){E.enqueue({type:"error",error:S.error});return}const P=S.value,$=P.usageMetadata;$!=null&&(d=$);const A=(N=P.candidates)==null?void 0:N[0];if(A==null)return;const J=A.content,D=pe({groundingMetadata:A.groundingMetadata,generateId:v});if(D!=null)for(const x of D)x.sourceType==="url"&&!r.has(x.url)&&(r.add(x.url),E.enqueue(x));if(J!=null){const x=(R=J.parts)!=null?R:[];for(const T of x)if("executableCode"in T&&((C=T.executableCode)!=null&&C.code)){const j=v();h=j,E.enqueue({type:"tool-call",toolCallId:j,toolName:"code_execution",input:JSON.stringify(T.executableCode),providerExecuted:!0})}else if("codeExecutionResult"in T&&T.codeExecutionResult){const j=h;j&&(E.enqueue({type:"tool-result",toolCallId:j,toolName:"code_execution",result:{outcome:T.codeExecutionResult.outcome,output:T.codeExecutionResult.output}}),h=void 0)}else"text"in T&&T.text!=null&&T.text.length>0?T.thought===!0?(o!==null&&(E.enqueue({type:"text-end",id:o}),o=null),t===null&&(t=String(g++),E.enqueue({type:"reasoning-start",id:t,providerMetadata:T.thoughtSignature?{[u]:{thoughtSignature:T.thoughtSignature}}:void 0})),E.enqueue({type:"reasoning-delta",id:t,delta:T.text,providerMetadata:T.thoughtSignature?{[u]:{thoughtSignature:T.thoughtSignature}}:void 0})):(t!==null&&(E.enqueue({type:"reasoning-end",id:t}),t=null),o===null&&(o=String(g++),E.enqueue({type:"text-start",id:o,providerMetadata:T.thoughtSignature?{[u]:{thoughtSignature:T.thoughtSignature}}:void 0})),E.enqueue({type:"text-delta",id:o,delta:T.text,providerMetadata:T.thoughtSignature?{[u]:{thoughtSignature:T.thoughtSignature}}:void 0})):"inlineData"in T&&E.enqueue({type:"file",mediaType:T.inlineData.mimeType,data:T.inlineData.data});const Q=Pe({parts:J.parts,generateId:v,providerOptionsName:u});if(Q!=null)for(const T of Q)E.enqueue({type:"tool-input-start",id:T.toolCallId,toolName:T.toolName,providerMetadata:T.providerMetadata}),E.enqueue({type:"tool-input-delta",id:T.toolCallId,delta:T.args,providerMetadata:T.providerMetadata}),E.enqueue({type:"tool-input-end",id:T.toolCallId,providerMetadata:T.providerMetadata}),E.enqueue({type:"tool-call",toolCallId:T.toolCallId,toolName:T.toolName,input:T.args,providerMetadata:T.providerMetadata}),m=!0}A.finishReason!=null&&(_={unified:ce({finishReason:A.finishReason,hasToolCalls:m}),raw:A.finishReason},p={[u]:{promptFeedback:(w=P.promptFeedback)!=null?w:null,groundingMetadata:(i=A.groundingMetadata)!=null?i:null,urlContextMetadata:(M=A.urlContextMetadata)!=null?M:null,safetyRatings:(K=A.safetyRatings)!=null?K:null}},$!=null&&(p[u].usageMetadata=$))},flush(S){o!==null&&S.enqueue({type:"text-end",id:o}),t!==null&&S.enqueue({type:"reasoning-end",id:t}),S.enqueue({type:"finish",finishReason:_,usage:se(d),providerMetadata:p})}})),response:{headers:y},request:{body:a}}}};function Pe({parts:e,generateId:a,providerOptionsName:c}){const u=e?.filter(n=>"functionCall"in n);return u==null||u.length===0?void 0:u.map(n=>({type:"tool-call",toolCallId:a(),toolName:n.functionCall.name,args:JSON.stringify(n.functionCall.args),providerMetadata:n.thoughtSignature?{[c]:{thoughtSignature:n.thoughtSignature}}:void 0}))}function pe({groundingMetadata:e,generateId:a}){var c,u,n,y,f;if(!e?.groundingChunks)return;const _=[];for(const d of e.groundingChunks)if(d.web!=null)_.push({type:"source",sourceType:"url",id:a(),url:d.web.uri,title:(c=d.web.title)!=null?c:void 0});else if(d.retrievedContext!=null){const p=d.retrievedContext.uri,v=d.retrievedContext.fileSearchStore;if(p&&(p.startsWith("http://")||p.startsWith("https://")))_.push({type:"source",sourceType:"url",id:a(),url:p,title:(u=d.retrievedContext.title)!=null?u:void 0});else if(p){const m=(n=d.retrievedContext.title)!=null?n:"Unknown Document";let o="application/octet-stream",t;p.endsWith(".pdf")?(o="application/pdf",t=p.split("/").pop()):p.endsWith(".txt")?(o="text/plain",t=p.split("/").pop()):p.endsWith(".docx")?(o="application/vnd.openxmlformats-officedocument.wordprocessingml.document",t=p.split("/").pop()):p.endsWith(".doc")?(o="application/msword",t=p.split("/").pop()):(p.match(/\.(md|markdown)$/)&&(o="text/markdown"),t=p.split("/").pop()),_.push({type:"source",sourceType:"document",id:a(),mediaType:o,title:m,filename:t})}else if(v){const m=(y=d.retrievedContext.title)!=null?y:"Unknown Document";_.push({type:"source",sourceType:"document",id:a(),mediaType:"application/octet-stream",title:m,filename:v.split("/").pop()})}}else d.maps!=null&&d.maps.uri&&_.push({type:"source",sourceType:"url",id:a(),url:d.maps.uri,title:(f=d.maps.title)!=null?f:void 0});return _.length>0?_:void 0}var Te=()=>l({webSearchQueries:b(s()).nullish(),retrievalQueries:b(s()).nullish(),searchEntryPoint:l({renderedContent:s()}).nullish(),groundingChunks:b(l({web:l({uri:s(),title:s().nullish()}).nullish(),retrievedContext:l({uri:s().nullish(),title:s().nullish(),text:s().nullish(),fileSearchStore:s().nullish()}).nullish(),maps:l({uri:s().nullish(),title:s().nullish(),text:s().nullish(),placeId:s().nullish()}).nullish()})).nullish(),groundingSupports:b(l({segment:l({startIndex:I().nullish(),endIndex:I().nullish(),text:s().nullish()}).nullish(),segment_text:s().nullish(),groundingChunkIndices:b(I()).nullish(),supportChunkIndices:b(I()).nullish(),confidenceScores:b(I()).nullish(),confidenceScore:b(I()).nullish()})).nullish(),retrievalMetadata:Ee([l({webDynamicRetrievalScore:I()}),l({})]).nullish()}),Se=()=>l({parts:b(Ee([l({functionCall:l({name:s(),args:De()}),thoughtSignature:s().nullish()}),l({inlineData:l({mimeType:s(),data:s()}),thoughtSignature:s().nullish()}),l({executableCode:l({language:s(),code:s()}).nullish(),codeExecutionResult:l({outcome:s(),output:s()}).nullish(),text:s().nullish(),thought:L().nullish(),thoughtSignature:s().nullish()})])).nullish()}),ee=()=>l({category:s().nullish(),probability:s().nullish(),probabilityScore:I().nullish(),severity:s().nullish(),severityScore:I().nullish(),blocked:L().nullish()}),Ie=l({cachedContentTokenCount:I().nullish(),thoughtsTokenCount:I().nullish(),promptTokenCount:I().nullish(),candidatesTokenCount:I().nullish(),totalTokenCount:I().nullish(),trafficType:s().nullish()}),be=()=>l({urlMetadata:b(l({retrievedUrl:s(),urlRetrievalStatus:s()}))}),He=G(()=>V(l({candidates:b(l({content:Se().nullish().or(l({}).strict()),finishReason:s().nullish(),safetyRatings:b(ee()).nullish(),groundingMetadata:Te().nullish(),urlContextMetadata:be().nullish()})),usageMetadata:Ie.nullish(),promptFeedback:l({blockReason:s().nullish(),safetyRatings:b(ee()).nullish()}).nullish()}))),Ke=G(()=>V(l({candidates:b(l({content:Se().nullish(),finishReason:s().nullish(),safetyRatings:b(ee()).nullish(),groundingMetadata:Te().nullish(),urlContextMetadata:be().nullish()})).nullish(),usageMetadata:Ie.nullish(),promptFeedback:l({blockReason:s().nullish(),safetyRatings:b(ee()).nullish()}).nullish()}))),$e=Re({id:"google.code_execution",inputSchema:l({language:s().describe("The programming language of the code."),code:s().describe("The code to be executed.")}),outputSchema:l({outcome:s().describe('The outcome of the execution (e.g., "OUTCOME_OK").'),output:s().describe("The output from the code execution.")})}),Fe=Y({id:"google.enterprise_web_search",inputSchema:G(()=>V(l({})))}),Be=l({fileSearchStoreNames:b(s()).describe("The names of the file_search_stores to retrieve from. Example: `fileSearchStores/my-file-search-store-123`"),topK:I().int().positive().describe("The number of file search retrieval chunks to retrieve.").optional(),metadataFilter:s().describe("Metadata filter to apply to the file search retrieval documents. See https://google.aip.dev/160 for the syntax of the filter expression.").optional()}).passthrough(),qe=G(()=>V(Be)),We=Y({id:"google.file_search",inputSchema:qe}),Ye=Y({id:"google.google_maps",inputSchema:G(()=>V(l({})))}),Je=Y({id:"google.google_search",inputSchema:G(()=>V(l({mode:O(["MODE_DYNAMIC","MODE_UNSPECIFIED"]).default("MODE_UNSPECIFIED"),dynamicThreshold:I().default(1)})))}),je=Y({id:"google.url_context",inputSchema:G(()=>V(l({})))}),Xe=Y({id:"google.vertex_rag_store",inputSchema:l({ragCorpus:s(),topK:I().optional()})}),H={googleSearch:Je,enterpriseWebSearch:Fe,googleMaps:Ye,urlContext:je,fileSearch:We,codeExecution:$e,vertexRagStore:Xe},Ce="4.0.45",ze=l({error:l({code:I().nullable(),message:s(),status:s()})}),te=ve({errorSchema:ze,errorToMessage:e=>e.error.message}),ge=l({outputDimensionality:I().optional(),taskType:O(["SEMANTIC_SIMILARITY","CLASSIFICATION","CLUSTERING","RETRIEVAL_DOCUMENT","RETRIEVAL_QUERY","QUESTION_ANSWERING","FACT_VERIFICATION","CODE_RETRIEVAL_QUERY"]).optional(),title:s().optional(),autoTruncate:L().optional()}),Qe=class{constructor(e,a){this.specificationVersion="v3",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0,this.modelId=e,this.config=a}get provider(){return this.config.provider}async doEmbed({values:e,headers:a,abortSignal:c,providerOptions:u}){let n=await B({provider:"vertex",providerOptions:u,schema:ge});if(n==null&&(n=await B({provider:"google",providerOptions:u,schema:ge})),n=n??{},e.length>this.maxEmbeddingsPerCall)throw new xe({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const y=q(await U(this.config.headers),a),f=`${this.config.baseURL}/models/${this.modelId}:predict`,{responseHeaders:_,value:d,rawValue:p}=await W({url:f,headers:y,body:{instances:e.map(v=>({content:v,task_type:n.taskType,title:n.title})),parameters:{outputDimensionality:n.outputDimensionality,autoTruncate:n.autoTruncate}},failedResponseHandler:te,successfulResponseHandler:z(Ze),abortSignal:c,fetch:this.config.fetch});return{warnings:[],embeddings:d.predictions.map(v=>v.embeddings.values),usage:{tokens:d.predictions.reduce((v,m)=>v+m.embeddings.statistics.token_count,0)},response:{headers:_,body:p}}}},Ze=l({predictions:b(l({embeddings:l({values:b(I()),statistics:l({token_count:I()})})}))}),et=class{constructor(e,a){this.modelId=e,this.config=a,this.specificationVersion="v3",this.maxImagesPerCall=4}get provider(){return this.config.provider}async doGenerate({prompt:e,n:a,size:c,aspectRatio:u,seed:n,providerOptions:y,headers:f,abortSignal:_,files:d,mask:p}){var v,m,o,t,g,r,h;const S=[];c!=null&&S.push({type:"unsupported",feature:"size",details:"This model does not support the `size` option. Use `aspectRatio` instead."});const E=await B({provider:"vertex",providerOptions:y,schema:ot}),{edit:N,...R}=E??{},{mode:C,baseSteps:w,maskMode:i,maskDilation:M}=N??{},K=d!=null&&d.length>0;let P;if(K){const D=[];for(let x=0;x<d.length;x++){const Q=d[x];D.push({referenceType:"REFERENCE_TYPE_RAW",referenceId:x+1,referenceImage:{bytesBase64Encoded:he(Q)}})}p!=null&&D.push({referenceType:"REFERENCE_TYPE_MASK",referenceId:d.length+1,referenceImage:{bytesBase64Encoded:he(p)},maskImageConfig:{maskMode:i??"MASK_MODE_USER_PROVIDED",...M!=null?{dilation:M}:{}}}),P={instances:[{prompt:e,referenceImages:D}],parameters:{sampleCount:a,...u!=null?{aspectRatio:u}:{},...n!=null?{seed:n}:{},editMode:C??"EDIT_MODE_INPAINT_INSERTION",...w!=null?{editConfig:{baseSteps:w}}:{},...R}}}else P={instances:[{prompt:e}],parameters:{sampleCount:a,...u!=null?{aspectRatio:u}:{},...n!=null?{seed:n}:{},...R}};const $=(o=(m=(v=this.config._internal)==null?void 0:v.currentDate)==null?void 0:m.call(v))!=null?o:new Date,{value:A,responseHeaders:J}=await W({url:`${this.config.baseURL}/models/${this.modelId}:predict`,headers:q(await U(this.config.headers),f),body:P,failedResponseHandler:te,successfulResponseHandler:z(tt),abortSignal:_,fetch:this.config.fetch});return{images:(g=(t=A.predictions)==null?void 0:t.map(({bytesBase64Encoded:D})=>D))!=null?g:[],warnings:S,response:{timestamp:$,modelId:this.modelId,headers:J},providerMetadata:{vertex:{images:(h=(r=A.predictions)==null?void 0:r.map(D=>{const{prompt:x}=D;return{...x!=null&&{revisedPrompt:x}}}))!=null?h:[]}}}}},tt=l({predictions:b(l({bytesBase64Encoded:s(),mimeType:s(),prompt:s().nullish()})).nullish()}),ot=l({negativePrompt:s().nullish(),personGeneration:O(["dont_allow","allow_adult","allow_all"]).nullish(),safetySetting:O(["block_low_and_above","block_medium_and_above","block_only_high","block_none"]).nullish(),addWatermark:L().nullish(),storageUri:s().nullish(),sampleImageSize:O(["1K","2K"]).nullish(),edit:l({baseSteps:I().nullish(),mode:O(["EDIT_MODE_INPAINT_INSERTION","EDIT_MODE_INPAINT_REMOVAL","EDIT_MODE_OUTPAINT","EDIT_MODE_CONTROLLED_EDITING","EDIT_MODE_PRODUCT_IMAGE","EDIT_MODE_BGSWAP"]).nullish(),maskMode:O(["MASK_MODE_DEFAULT","MASK_MODE_USER_PROVIDED","MASK_MODE_DETECTION_BOX","MASK_MODE_CLOTHING_AREA","MASK_MODE_PARSED_PERSON"]).nullish(),maskDilation:I().nullish()}).nullish()});function he(e){if(e.type==="url")throw new Error("URL-based images are not supported for Google Vertex image editing. Please provide the image data directly.");return typeof e.data=="string"?e.data:ye(e.data)}var nt={googleSearch:H.googleSearch,enterpriseWebSearch:H.enterpriseWebSearch,googleMaps:H.googleMaps,urlContext:H.urlContext,fileSearch:H.fileSearch,codeExecution:H.codeExecution,vertexRagStore:H.vertexRagStore},at=class{constructor(e,a){this.modelId=e,this.config=a,this.specificationVersion="v3"}get provider(){return this.config.provider}get maxVideosPerCall(){return 4}async doGenerate(e){var a,c,u,n,y,f;const _=(u=(c=(a=this.config._internal)==null?void 0:a.currentDate)==null?void 0:c.call(a))!=null?u:new Date,d=[],p=await B({provider:"vertex",providerOptions:e.providerOptions,schema:it}),v=[{}],m=v[0];if(e.prompt!=null&&(m.prompt=e.prompt),e.image!=null)if(e.image.type==="url")d.push({type:"unsupported",feature:"URL-based image input",details:"Vertex AI video models require base64-encoded images or GCS URIs. URL will be ignored."});else{const i=typeof e.image.data=="string"?e.image.data:ye(e.image.data);m.image={bytesBase64Encoded:i}}p?.referenceImages!=null&&(m.referenceImages=p.referenceImages);const o={sampleCount:e.n};if(e.aspectRatio&&(o.aspectRatio=e.aspectRatio),e.resolution){const i={"1280x720":"720p","1920x1080":"1080p","3840x2160":"4k"};o.resolution=i[e.resolution]||e.resolution}if(e.duration&&(o.durationSeconds=e.duration),e.seed&&(o.seed=e.seed),p!=null){const i=p;i.personGeneration!==void 0&&i.personGeneration!==null&&(o.personGeneration=i.personGeneration),i.negativePrompt!==void 0&&i.negativePrompt!==null&&(o.negativePrompt=i.negativePrompt),i.generateAudio!==void 0&&i.generateAudio!==null&&(o.generateAudio=i.generateAudio),i.gcsOutputDirectory!==void 0&&i.gcsOutputDirectory!==null&&(o.gcsOutputDirectory=i.gcsOutputDirectory);for(const[M,K]of Object.entries(i))["pollIntervalMs","pollTimeoutMs","personGeneration","negativePrompt","generateAudio","gcsOutputDirectory","referenceImages"].includes(M)||(o[M]=K)}const{value:t}=await W({url:`${this.config.baseURL}/models/${this.modelId}:predictLongRunning`,headers:q(await U(this.config.headers),e.headers),body:{instances:v,parameters:o},successfulResponseHandler:z(me),failedResponseHandler:te,abortSignal:e.abortSignal,fetch:this.config.fetch}),g=t.name;if(!g)throw new F({name:"VERTEX_VIDEO_GENERATION_ERROR",message:"No operation name returned from API"});const r=(n=p?.pollIntervalMs)!=null?n:1e4,h=(y=p?.pollTimeoutMs)!=null?y:6e5,S=Date.now();let E=t,N;for(;!E.done;){if(Date.now()-S>h)throw new F({name:"VERTEX_VIDEO_GENERATION_TIMEOUT",message:`Video generation timed out after ${h}ms`});if(await we(r),(f=e.abortSignal)!=null&&f.aborted)throw new F({name:"VERTEX_VIDEO_GENERATION_ABORTED",message:"Video generation request was aborted"});const{value:i,responseHeaders:M}=await W({url:`${this.config.baseURL}/models/${this.modelId}:fetchPredictOperation`,headers:q(await U(this.config.headers),e.headers),body:{operationName:g},successfulResponseHandler:z(me),failedResponseHandler:te,abortSignal:e.abortSignal,fetch:this.config.fetch});E=i,N=M}if(E.error)throw new F({name:"VERTEX_VIDEO_GENERATION_FAILED",message:`Video generation failed: ${E.error.message}`});const R=E.response;if(!R?.videos||R.videos.length===0)throw new F({name:"VERTEX_VIDEO_GENERATION_ERROR",message:`No videos in response. Response: ${JSON.stringify(E)}`});const C=[],w=[];for(const i of R.videos)i.bytesBase64Encoded?(C.push({type:"base64",data:i.bytesBase64Encoded,mediaType:i.mimeType||"video/mp4"}),w.push({mimeType:i.mimeType})):i.gcsUri&&(C.push({type:"url",url:i.gcsUri,mediaType:i.mimeType||"video/mp4"}),w.push({gcsUri:i.gcsUri,mimeType:i.mimeType}));if(C.length===0)throw new F({name:"VERTEX_VIDEO_GENERATION_ERROR",message:"No valid videos in response"});return{videos:C,warnings:d,response:{timestamp:_,modelId:this.modelId,headers:N},providerMetadata:{"google-vertex":{videos:w}}}}},me=l({name:s().nullish(),done:L().nullish(),error:l({code:I().nullish(),message:s(),status:s().nullish()}).nullish(),response:l({videos:b(l({bytesBase64Encoded:s().nullish(),gcsUri:s().nullish(),mimeType:s().nullish()})).nullish(),raiMediaFilteredCount:I().nullish()}).nullish()}),it=G(()=>V(l({pollIntervalMs:I().positive().nullish(),pollTimeoutMs:I().positive().nullish(),personGeneration:O(["dont_allow","allow_adult","allow_all"]).nullish(),negativePrompt:s().nullish(),generateAudio:L().nullish(),gcsOutputDirectory:s().nullish(),referenceImages:b(l({bytesBase64Encoded:s().nullish(),gcsUri:s().nullish()})).nullish()}).passthrough())),rt="https://aiplatform.googleapis.com/v1/publishers/google";function st(e,a){return async(c,u)=>{const n={...u,headers:{...u?.headers?Me(u.headers):{},"x-goog-api-key":e}};return(a??fetch)(c.toString(),n)}}function fe(e={}){const a=ae({settingValue:e.apiKey,environmentVariableName:"GOOGLE_VERTEX_API_KEY"}),c=()=>Z({settingValue:e.project,settingName:"project",environmentVariableName:"GOOGLE_VERTEX_PROJECT",description:"Google Vertex project"}),u=()=>Z({settingValue:e.location,settingName:"location",environmentVariableName:"GOOGLE_VERTEX_LOCATION",description:"Google Vertex location"}),n=()=>{var m,o;if(a)return(m=re(e.baseURL))!=null?m:rt;const t=u(),g=c(),r=`${t==="global"?"":t+"-"}aiplatform.googleapis.com`;return(o=re(e.baseURL))!=null?o:`https://${r}/v1beta1/projects/${g}/locations/${t}/publishers/google`},y=m=>{const o=async()=>{var t;const g=await U((t=e.headers)!=null?t:{});return _e(g,`ai-sdk/google-vertex/${Ce}`)};return{provider:`google.vertex.${m}`,headers:o,fetch:a?st(a,e.fetch):e.fetch,baseURL:n()}},f=m=>{var o;return new Ue(m,{...y("chat"),generateId:(o=e.generateId)!=null?o:oe,supportedUrls:()=>({"*":[/^https?:\/\/.*$/,/^gs:\/\/.*$/]})})},_=m=>new Qe(m,y("embedding")),d=m=>new et(m,y("image")),p=m=>{var o;return new at(m,{...y("video"),generateId:(o=e.generateId)!=null?o:oe})},v=function(m){if(new.target)throw new Error("The Google Vertex AI model function cannot be called with the new keyword.");return f(m)};return v.specificationVersion="v3",v.languageModel=f,v.embeddingModel=_,v.textEmbeddingModel=_,v.image=d,v.imageModel=d,v.video=p,v.videoModel=p,v.tools=nt,v}var lt=async()=>{try{return{clientEmail:Z({settingValue:void 0,settingName:"clientEmail",environmentVariableName:"GOOGLE_CLIENT_EMAIL",description:"Google client email"}),privateKey:Z({settingValue:void 0,settingName:"privateKey",environmentVariableName:"GOOGLE_PRIVATE_KEY",description:"Google private key"}),privateKeyId:ae({settingValue:void 0,environmentVariableName:"GOOGLE_PRIVATE_KEY_ID"})}}catch(e){throw new Error(`Failed to load Google credentials: ${e.message}`)}},X=e=>btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""),ut=async e=>{const u=e.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\s/g,""),n=atob(u),y=new Uint8Array(n.length);for(let f=0;f<n.length;f++)y[f]=n.charCodeAt(f);return await crypto.subtle.importKey("pkcs8",y,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!0,["sign"])},dt=async e=>{const a=Math.floor(Date.now()/1e3),c={alg:"RS256",typ:"JWT"};e.privateKeyId&&(c.kid=e.privateKeyId);const u={iss:e.clientEmail,scope:"https://www.googleapis.com/auth/cloud-platform",aud:"https://oauth2.googleapis.com/token",exp:a+3600,iat:a},n=await ut(e.privateKey),y=`${X(JSON.stringify(c))}.${X(JSON.stringify(u))}`,_=new TextEncoder().encode(y),d=await crypto.subtle.sign("RSASSA-PKCS1-v1_5",n,_),p=X(String.fromCharCode(...new Uint8Array(d)));return`${X(JSON.stringify(c))}.${X(JSON.stringify(u))}.${p}`};async function ct(e){try{const a=e||await lt(),c=await dt(a),u=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:_e({"Content-Type":"application/x-www-form-urlencoded"},`ai-sdk/google-vertex/${Ce}`,Ne()),body:new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:c})});if(!u.ok)throw new Error(`Token request failed: ${u.statusText}`);return(await u.json()).access_token}catch(a){throw a}}function pt(e={}){return ae({settingValue:e.apiKey,environmentVariableName:"GOOGLE_VERTEX_API_KEY"})?fe(e):fe({...e,headers:async()=>({Authorization:`Bearer ${await ct(e.googleCredentials)}`,...await U(e.headers)})})}pt();export{pt as createVertex};
